(function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?this:self:global:window,t.index=e()}})(function(){var e=Math.floor;return function(){function r(s,e,n){function o(d,i){if(!e[d]){if(!s[d]){var l="function"==typeof require&&require;if(!i&&l)return l(d,!0);if(t)return t(d,!0);var c=new Error("Cannot find module '"+d+"'");throw c.code="MODULE_NOT_FOUND",c}var a=e[d]={exports:{}};s[d][0].call(a.exports,function(e){var t=s[d][1][e];return o(t||e)},a,a.exports,r,s,e,n)}return e[d].exports}for(var t="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}return r}()({1:[function(t,n,o){'use strict';function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function inheritBackend(e,t){t.prototype=Object.create(e.prototype),t.prototype.constructor=t}function Tasks(){}function taskResClone(e){var t=Object.assign({},e);return delete t.id,delete t.etag,delete t.selfLink,t}function taskResNormalize(e){"completed"!=e.status||e.completed||(e.completed=new Date),"completed"!=e.status&&e.completed&&delete e.completed,"undefined"!=typeof e.due&&(e.due=i.parseDate(e.due)),"undefined"!=typeof e.completed&&(e.completed=i.parseDate(e.completed)),"undefined"!=typeof e.updated&&(e.updated=i.parseDate(e.updated))}function resourcePatch(e,t){Object.keys(t).forEach(function(n){if("id"!=n){var o=t[n];null==o?delete e[n]:e[n]=o}})}function toArray(e){return"undefined"==typeof e||null==e?e:(Array.isArray(e)||(e=[e]),e)}function toTaskId(e){return e&&e.id&&(e=e.id),e}function isEmpty(e){return!e||!Object.keys(e).length}function Backend(){this.onSignInStatus=new Callback,this.onTasklistAdded=new Callback,this.onTasklistEdited=new Callback,this.onTasklistDeleted=new Callback,this.onTaskAdded=new Callback,this.onTaskEdited=new Callback,this.onTaskMoved=new Callback,this.onTaskDeleted=new Callback,this.cache=new TaskCache,this.showDeleted=!1}function TaskCache(){this.items={}}function DummyBackend(e,t){Backend.call(this),this.error=t,this.__proto__=Object.create(DummyBackend.prototype),this.__proto__.constructor={},this.__proto__.constructor.name=e}"undefined"!=typeof t&&t("./utils.js").importSelf();var s=new Unit("undefined"!=typeof o&&o),a=[];s["export"]({backends:a}),s["export"](function registerBackend(e,t){t&&(e.uiName=t),a.push(e)}),s["export"](inheritBackend);s["export"](function Tasklist(e){for(var t in _classCallCheck(this,Tasklist),this.id=void 0,this.title=void 0,e)this[t]=e[t]});var i=function Task(e){for(var t in _classCallCheck(this,Task),this.id=void 0,this.title=void 0,this.notes=void 0,this.status=void 0,this.completed=void 0,this.due=void 0,this.updated=void 0,this.tasklist=void 0,this.parent=void 0,this.position=void 0,e)this[t]=e[t]};s["export"](i),i.parseDate=function(e){if("undefined"==typeof e||e instanceof Date)return e;var t=new Date(e);return t instanceof Date&&!isNaN(t.getTime())?t:(console.warn("Cannot convert",e,"to JS date"),e)},s["export"](Tasks),Tasks.sort=function(e){return e.sort(function(e,t){return e.position-t.position})},Tasks.dict=function(e){var t={};for(var n in e)t[e[n].id]=e[n];return t},s["export"](taskResClone),s["export"](function taskResSetCompleted(e,t,n){t?(e.status="completed",!n&&(n=new Date),e.completed=n):(e.status="needsAction",e.completed=null)}),s["export"](taskResNormalize),s["export"](resourcePatch),s["export"](toArray),s["export"](function toTaskIds(e){if("undefined"==typeof e||null==e)return e;Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++)e[t].id&&(e[t]=e[t].id);return e}),s["export"](toTaskId),s["export"](isEmpty),s["export"](function isArrayEmpty(e){if(e&&!Array.isArray(e))throw"Array expected, found: "+e;return!e||0>=e.length}),s["export"](function diffDict(e,t,n){n=n||function(e,t){return e==t},e=e||{},t=t||{};var o={};return Object.keys(e).forEach(function(s){var a=e[s],i=t[s];i&&n(a,i)||(o[s]={oldValue:a,newValue:i})}),Object.keys(t).forEach(function(n){var s=e[n];s||(o[n]={oldValue:s,newValue:t[n]})}),o}),s["export"](function maybeStrToDate(e){if("string"==typeof e){var t=new Date(e);if(t instanceof Date&&!isNaN(t))return t}return e}),s["export"](Backend),Backend.prototype.init=function(){return this.connect?this.connect():Promise.resolve()},Backend.prototype.settingsPage=function(){return null},Backend.prototype.setup=function(e){return this.signin(e)},Backend.prototype.signin=function(e){return this._signedIn=!0,this.notifySignInStatus(!0),Promise.resolve(e)},Backend.prototype.signout=function(){return this._signedIn=!1,this.notifySignInStatus(!1),Promise.resolve()},Backend.prototype.isSignedIn=function(){return this._signedIn||!1},Backend.prototype.notifySignInStatus=function(e){this.onSignInStatus.notify(this,e)},Backend.prototype.autoName=function(){return this.constructor.uiName||this.constructor.name},Backend.prototype.uiName=function(){return this.customName||this.autoName()},Backend.prototype.tasklistPatch=function(e){var t=this;return e.id?this.tasklistGet(e.id).then(function(n){return resourcePatch(n,e),t.tasklistUpdate(n)}):Promise.reject("Backend.tasklistPatch(): id not specified")},Backend.prototype.TASK_FIELDS=["id","title","notes","status","parent","position","updated","completed","due","deleted","hidden","links"],Backend.prototype.taskToResource=function(e){var t={};for(var n in e)-1!=this.TASK_FIELDS.indexOf(n)&&(t[n]=e[n]);return taskResNormalize(t),t},Backend.prototype.resourceToTask=function(e){return e instanceof i?e:new i(e)},Backend.prototype.get=function(e,t){var n=this;if(!this.getOne&&!this.getMultiple)throw"Backend: Querying tasks is not implemented";if(!Array.isArray(e))return this.getOne?this.getOne(e,t).then(function(e){return n.cache.update(e),e}):this.getMultiple([e],t).then(function(t){return n.cache.update(t[e]),t[e]});if(this.getMultiple)return this.getMultiple(e,t).then(function(e){return n.cache.update(e),e});for(var o=[],s=0;s<e.length;s++)o.push(this.getOne(e[s],t));return Promise.all(o).then(function(e){var t={};return e.forEach(function(e){return t[e.id]=e}),n.cache.update(t),t})},Backend.prototype.patch=function(e,t){var n=this;return e.id?this.get(e.id,t).then(function(o){return resourcePatch(o,e),n.update(o,t)}).then(function(t){return n.cache.patch(e),t}):Promise.reject("Backend.patch(): id not specified")},Backend.prototype.insertMultiple=function(e,t){var n=this,o={},s=[],a=function _loop(a){s.push(n.insert(e[a],e[a].previousId,t).then(function(e){o[a]=e}))};for(var i in e)a(i);return Promise.all(s).then(function(){return o})},Backend.prototype.deleteWithChildren=function(e,t){var n=this;e=toTaskId(e),t||(t=this.selectedTaskList);var o=[e],s=null;return s=t==this.selectedTaskList?this.getAllChildren(e,t).then(function(e){e.forEach(function(e){return o.push(e.id)})}):Promise.resolve(),s.then(function(){for(var e=0;e<o.length;e++)o[e]=n.cache.get(o[e])||o[e],n.cache["delete"](o[e].id||o[e])}).then(function(){return n["delete"](o,t)})},Backend.prototype.move=function(e,t,n,o){var s=this;e=toArray(e),t&&t.id&&(t=t.id),n&&n.id&&(n=n.id),o||(o=this.selectedTaskList);var a=[];return e.reverse().forEach(function(e){a.push(s._moveOne(e,t,n,o))}),Promise.all(a)},Backend.prototype._moveOne=function(e,t,n,o){var s=this;return e&&e.id&&(e=e.id),o||(o=this.selectedTaskList),this.choosePosition(t,n,o,e).then(function(n){var a={id:e,parent:t,position:n};return s.patch(a,o)})},Backend.prototype.moveChildren=function(e,t,n,o){var s=this;e&&e.id&&(e=e.id),t&&t.id&&(t=t.id),n&&n.id&&(n=n.id),o||(o=this.selectedTaskList),this.getChildren(e,o).then(function(e){if(!isEmpty(e)){var a=[];return e.forEach(function(e){return a.push(e.id)}),s.move(a,t,n,o)}})},Backend.prototype.newTopmostPosition=function(){return new Date(2001,1,1,0,0,0)-new Date},Backend.prototype.newDownmostPosition=function(){return new Date-new Date(2001,1,1,0,0,0)},Backend.prototype.choosePosition=function(t,n,o,s){var a=this;if("undefined"==typeof n)return Promise.resolve(this.newDownmostPosition());if(null==n)return Promise.resolve(this.newTopmostPosition());if(o&&o!=this.selectedTaskList)throw"ChoosePosition: Currently unsupported for lists other than current";return this.getChildren(t,o).then(function(t){var o=null,i=null,d=null;if(!n)o=a.newTopmostPosition(),d=-1,1<=t.length&&t[0].position<o+1e3&&(o=t[0].position-1e3);else for(d=0;d<t.length;d++)if(t[d].id==n){o=t[d].position;break}i=d+1<t.length?t[d+1].position:a.newDownmostPosition(),i=+i,o=+o;var r=e((i+o)/2);return r<o+1&&(r=o+1),r>=i?a._positionShiftDown(t,d+1,s).then(function(){return r}):r})},Backend.prototype._positionShiftDown=function(e,t,n){for(var o=[],s=e[t].position,a=t;a<e.length&&!(e[a].id==n);a++){if(e[a].position>s)break;++s,e[a].position=s,o.push(this.patch({id:e[a].id,position:e[a].position}))}return 0>=o.length?Promise.resolve():Promise.all(o)},Backend.prototype.copyToList=function(e,t,n,o){var s=this;if(console.debug("Backend.copyToList:",arguments),isEmpty(e))return Promise.resolve();n||(n=this);var a={};for(var i in e){var d=e[i],r=d.task||this.cache.get(i);if(!r)throw"Backend.copyToList: Task data not found: "+i;r=taskResClone(r),r.id=null,r.parent=d.parent,r.previousId=d.previous,a[i]=r}if(isEmpty(a))return console.debug("Backend.copyToList: newItems is empty: ",a),Promise.resolve();var l=n.insertMultiple(a,t);return o&&(l=l.then(function(e){return console.debug("Backend.copyToList: insert results=",e),s.copyChildrenTo(e,t,n)})),l},Backend.prototype.copyChildrenTo=function(e,t,n){var o=this;if(console.debug("Backend.copyChildrenTo:",arguments),isEmpty(e))return Promise.resolve();n||(n=this);var s=[],a=[];for(var i in e)s.push(i),a.push(this.getChildren(i));return Promise.all(a).then(function(a){console.debug("Backend.copyChildrenTo: oldTasks=",a);for(var d={},r=function _loop2(t){var n=s[t],o=a[t];o.reverse().forEach(function(t){var o={};o.task=t,o.parent=e[n].id,o.previous=null,d[t.id]=o})},l=0;l<s.length;l++)r(l);return isEmpty(d)?(console.debug("Backend.copyChildrenTo: nothing to copy"),Promise.resolve()):o.copyToList(d,t,n,!0)})},Backend.prototype.moveToList=function(e,t,n){var o=this;if(console.debug("Backend.moveToList:",arguments),n||(n=this),!t||t==this.selectedTaskList)return Promise.resolve();var s=this.selectedTaskList;return this.cachedGet(e).then(function(s){console.debug("Backend.moveToList: queried task=",s),e=s;var a={};return a[e.id]={task:e,parent:null,previous:null},o.copyToList(a,t,n,!0)}).then(function(){return o["delete"](e,s)})},Backend.prototype.selectTaskList=function(e){return this.selectedTaskList==e?Promise.resolve(this.cache.getList(e)):(this.selectedTaskList=e,this.cache.clear(),this.selectedTaskList?this.cacheLoadList(this.selectedTaskList):Promise.resolve([]))},s["export"](TaskCache),TaskCache.prototype.clear=function(){this.items={}},TaskCache.prototype.add=function(e){this.update(e)},TaskCache.prototype.addList=function(e,t){for(var n=0;n<e.length;n++)e[n].deleted||(e[n].tasklist=t,this.add(e[n]))},TaskCache.prototype["delete"]=function(e){Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++)delete this.items[e[t]]},TaskCache.prototype.deleteList=function(e){for(var t in this.items)this.items[t].tasklist==e&&delete this.items[t]},TaskCache.prototype.values=function(){return Object.values(this.items)},TaskCache.prototype.get=function(e){return this.items[e]},TaskCache.prototype.getList=function(e){var t=[];for(var n in this.items)this.items[n].tasklist==e&&t.push(this.items[n]);return t},TaskCache.prototype.update=function(e){Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++)this.items[e[t].id]=e[t]},TaskCache.prototype.patch=function(e){var t=this.items[e.id];t&&resourcePatch(t,e)},Backend.prototype.cacheLoadList=function(e){var t=this,n=this.list(e);return n=n.then(function(n){return t.cache.addList(n||[],e),n}),n},Backend.prototype.cachedGet=function(e,t){if(!e)return Promise.resolve();var n=Array.isArray(e);n||(e=[e]);var o={},s=[];for(var a in e){var i=e[a];if(i.id){o[i.id]=i;continue}var d=this.cache.get(i);d?o[i]=d:s.push(i)}console.debug("cachedGet: will query:",s);var r=0>=s.length?Promise.resolve({}):this.get(e,t);return r.then(function(t){for(var s in t)o[s]=t[s];return n?o:o[e[0]]})},Backend.prototype.getChildren=function(e){e&&e.id&&(e=e.id);var t=[];for(var n in this.cache.items){var o=this.cache.items[n];!e&&o.parent||e&&o.parent!=e||t.push(o)}return t=t.sort(function(e,t){return e.position-t.position}),Promise.resolve(t)},Backend.prototype.getAllChildren=function(e){e&&e.id&&(e=e.id);var t=[];for(var n in this.cache.items){for(var o=this.cache.items[n];o&&o.parent!=e;)o=o.parent?this.cache.items[o.parent]:null;o&&t.push(this.cache.items[n])}return Promise.resolve(t)},s["export"](DummyBackend),inheritBackend(Backend,DummyBackend),DummyBackend.prototype.init=function(){return Promise.reject(this.error)},DummyBackend.prototype.isSignedIn=function(){return!1},DummyBackend.prototype.signout=function(){return Promise.resolve()}},{"./utils.js":8}],2:[function(t,n,o){'use strict';function BackendDav(){Backend.call(this)}function insertDavAPIs(){return loadScripts({davjs:"dav/dav.js","ical.js":"dav/ical.js"})}"undefined"!=typeof t&&(t("./utils.js").importSelf(),importAll(t("./backend.js")));var s=new Unit("undefined"!=typeof o&&o);inherit(Backend,BackendDav),s["export"](BackendDav),registerBackend(BackendDav,"CalDAV"),BackendDav.prototype.connect=function(){return insertDavAPIs().then(function(){console.log("dav: insertDavAPIs completed")})["catch"](function(e){throw console.log("dav: insertDavAPIs error:",e),e})},BackendDav.prototype.settingsPage=function(){return{server:{type:"url",hint:"This is your DAV server root"},username:{type:"text"},password:{type:"password",hint:"Will be saved locally in your browser"},auth:{type:["Digest first","Basic first","Digest only"],default:"Digest first",hint:"Basic is faster but should only be used with HTTPS URLs. Leave \"Digest first\" if unsure"},serviceDiscovery:{type:"bool",default:!1,title:"Service discovery",hint:"Try to detect the correct DAV root URI instead of the one you provided. Not always needed but always slower startup."}}},BackendDav.prototype.setup=function(e){return e&&(e.username||e.password)&&("string"!=typeof e.auth||"digest only"!=e.auth)&&!(e.server+"").toLowerCase().startsWith("https:")&&!confirm("You're using non-HTTPS CalDAV server URL with authentication scheme that allows Basic auth.\nYour login/password might be passed in the open.\n\nFor better security, change the URL to HTTPS or enable 'Digest-only' authentication.\n\nDo you want to proceed in insecure way?")?Promise.reject("Cancelled"):Backend.prototype.setup.call(this,e)},BackendDav.prototype.signin=function(e){var t=this;if(console.debug("BackendDav.signin",e),!e||!e.server)return Promise.reject("Server URL required for CalDAV backend");var n=new dav.Credentials({username:e.username,password:e.password});if(this.xhr=new dav.transport.Basic(n),this.server=e.server,this.username=e.username,e&&"string"==typeof e.auth){var o=e.auth.toLowerCase();this.xhr.auth.authType="digest only"==o?"digest":"basic first"==o||"basic"==o?"basic":null}return dav.createAccount({server:e.server,xhr:this.xhr,serviceDiscovery:!e||e.serviceDiscovery})["catch"](function(e){return t.signout().then(function(){throw e})}).then(function(e){t.account=e,t._signedIn=!0,t.notifySignInStatus(!0)}).then(function(){return e})},BackendDav.prototype.signout=function(){return delete this.account,delete this.xhr,!0===this._signedIn&&(this._signedIn=!1,this.notifySignInStatus(!1)),Promise.resolve()},BackendDav.prototype.autoName=function(){var e=Backend.prototype.autoName.call(this);return this.server&&(e=e+" ("+this.server+")"),e},BackendDav.prototype.tasklistList=function(){if(!this.account)return Promise.reject("Not logged in");var e=[];return this.account.calendars.forEach(function(t){console.log("Found calendar named",t.displayName),e.push({id:t.url,title:t.displayName})}),Promise.resolve(e)},BackendDav.prototype.tasklistGet=function(e){if(!this.account)return Promise.reject("Not logged in");var t=this.findCalendar(e);return t?Promise.resolve({id:t.url,title:t.displayName}):Promise.reject("Task list not found")},BackendDav.prototype.findCalendar=function(e){for(var t=0,n;t<this.account.calendars.length;t++)if(n=this.account.calendars[t],n.url==e)return n;return null},BackendDav.prototype.datetimeToPosition=function(t){return t?(t instanceof ICAL.Time&&(t=t.toJSDate()),e(t-new Date(2001,1,1,0,0,0))):0},BackendDav.prototype.parseTodoObject=function(e){var t=Number.isNaN,n={comp:new ICAL.Component(ICAL.parse(e.calendarData)),obj:e,url:e.url},o=n.comp.getAllSubcomponents("vtodo");for(var s in o){var a=o[s];n.id=n.id||a.getFirstPropertyValue("uid"),a.sequence=a.getFirstPropertyValue("sequence")||0,(void 0===n.maxsequence||a.sequence>n.maxsequence)&&(n.maxsequence=a.sequence,n.maxsequenceEntry=a),a.hasRecur=a.hasProperty("rrule")||a.hasProperty("rdate"),a.hasRecur&&a.sequence>(n.basesequence||0)&&(n.basesequence=a.sequence,n.baseEntry=a)}if(n.baseEntry||(n.basesequence=n.maxsequence,n.baseEntry=n.maxsequenceEntry),n.baseEntry){n.title=n.baseEntry.getFirstPropertyValue("summary"),n.notes=n.baseEntry.getFirstPropertyValue("description"),n.status=n.baseEntry.getFirstPropertyValue("status"),n.status="COMPLETED"==n.status?"completed":"IN-PROGRESS"==n.status?"inProgress":"CANCELLED"==n.status?"cancelled":"needsAction";for(var i=n.baseEntry.getAllProperties("related-to"),d=0,r;d<i.length;d++)if(r=i[d].getParameter("reltype"),!(r&&"PARENT"!=r)){n.parent=i[d].getFirstValue();break}if(n.position=n.baseEntry.getFirstPropertyValue("x-apple-sort-order"),n.position){var l=parseInt(n.position,10);t(l)||(n.position=l)}if(n.position||(n.position=this.datetimeToPosition(n.baseEntry.getFirstPropertyValue("created")),n.positionAuto=n.position),n.due=n.baseEntry.getFirstPropertyValue("due"),!n.due&&(n.due=n.baseEntry.getFirstPropertyValue("dtstart"),n.due)){var p=n.baseEntry.getFirstPropertyValue("duration");p&&n.due.addDuration(p)}n.due&&(n.due=n.due.toJSDate()),n.completed=n.baseEntry.getFirstPropertyValue("completed"),n.completed&&(n.completed=n.completed.toJSDate())}return console.debug("parsedTodoObject:",n),n.id||console.log("Warning: Task has no ID"),n},BackendDav.prototype.parseTodoObjects=function(e,t){for(var n=[],o=0;o<e.length;o++){console.debug("Object["+o+"]",e[o].calendarData);var s=this.parseTodoObject(e[o]);s.tasklist=t,n.push(s)}return n},BackendDav.prototype.queryTasklist=function(e,t){var n=this,o=this.findCalendar(e);return o?dav.listCalendarObjects(o,{xhr:this.xhr,filters:t}).then(function(t){return n.parseTodoObjects(t,e)}):Promise.reject("Task list not found: "+e)},BackendDav.prototype.taskIdsFilter=function(e){for(var t=[],n=0,o;n<e.length;n++)o={type:"text-match",attrs:{collation:"i;octet"},value:e[n]},t.push(o);var s={type:"prop-filter",attrs:{name:"UID"},children:t};return 1<t.length&&(s.attrs.test="anyof"),[{type:"comp-filter",attrs:{name:"VCALENDAR"},children:[{type:"comp-filter",attrs:{name:"VTODO"},children:[s]}]}]},BackendDav.prototype.updateTodoObject=function(e,t,n){if(this.updateProperty(e,"summary",t.title,n),this.updateProperty(e,"description",t.notes,n),this.updateProperty(e,"related-to",t.parent,n,function(e){var t=e.getParameter("reltype");return!t||"PARENT"==t}),t.positionAuto&&t.position==t.positionAuto||this.updateProperty(e,"x-apple-sort-order",t.position,n),n&&"undefined"==typeof t.status||(null==t.status?e.removeProperty("status"):"completed"==t.status?e.updatePropertyWithValue("status","COMPLETED"):"inProgress"==t.status?e.updatePropertyWithValue("status","IN-PROGRESS"):"cancelled"==t.status?e.updatePropertyWithValue("status","CANCELLED"):e.updatePropertyWithValue("status","NEEDS-ACTION")),!n||"undefined"!=typeof t.due)if(null==t.due)e.removeProperty("due"),e.removeProperty("dtstart");else{var o=ICAL.Time.fromJSDate(Task.parseDate(t.due));e.updatePropertyWithValue("due",o);var s=e.getFirstPropertyValue("duration");s&&(s.isNegative=!0,o.addDuration(s)),e.updatePropertyWithValue("dtstart",o)}this.updateProperty(e,"completed",t.completed&&Task.parseDate(t.completed),n);var a=ICAL.Time.now();e.updatePropertyWithValue("last-modified",a)},BackendDav.prototype.updateProperty=function(e,t,n,o,s){if(!(o&&"undefined"==typeof n)){for(var a=e.getAllProperties(t),d=null,r=0;r<a.length;r++)if(!s||s(a[r])){d=a[r];break}n instanceof Date&&(n=ICAL.Time.fromJSDate(n)),!n&&d?e.removeProperty(d):d?d.setValue(n):n&&e.addPropertyWithValue(t,n)}},BackendDav.prototype.list=function(e){return this.queryTasklist(e,[{type:"comp-filter",attrs:{name:"VCALENDAR"},children:[{type:"comp-filter",attrs:{name:"VTODO"}}]}])},BackendDav.prototype.getOne=function(e,t){e=toTaskId(e),t||(t=this.selectedTaskList);var n=this.taskIdsFilter([e]);return this.queryTasklist(t,n).then(function(t){if(!Array.isArray(t)||0>=t.length||t[0].id!=e)throw new Error("Task not found: "+e);return t[0]})},BackendDav.prototype.update=function(e,t){return this.updateTaskObject(t||e.tasklist||this.selectedTaskList,e,!1)},BackendDav.prototype.patch=function(e,t){return this.updateTaskObject(t||e.tasklist||this.selectedTaskList,e,!0)},BackendDav.prototype.updateTaskObject=function(e,t,n){var o=this,s=this.findCalendar(e);if(!s)return Promise.reject("Task list not found: "+e);if(console.debug("updateTaskObject:",t),!n&&!t.baseEntry)return Promise.reject("Task has no VTODO entry associated with it");var a=this.taskIdsFilter([t.id]),i=null;return dav.listCalendarObjects(s,{xhr:this.xhr,filters:a}).then(function(s){return isEmpty(s)?Promise.reject("Task not found: "+t.id):1<s.length?Promise.reject("Task "+t.id+" stored across multiple ICS files on server"):(console.debug("updateTaskObject: preloaded objects=",s),i=o.parseTodoObject(s[0]),!i.baseEntry)?Promise.reject("Task is missing VTODO entries on the server"):n||i.basesequence==t.basesequence?(o.updateTodoObject(i.baseEntry,t,n),i.maxsequence+=1,i.maxsequenceEntry=i.baseEntry,i.basesequence=i.maxSequence,i.baseEntry.updatePropertyWithValue("sequence",i.maxsequence),console.debug("update:",i.comp),i.obj.calendarData=i.comp.toString(),console.debug("update.data:",i.obj.calendarData),i=o.parseTodoObject(i.obj),i.tasklist=e,console.debug("Reparsed task2:",i),dav.updateCalendarObject(i.obj,{xhr:o.xhr})):Promise.reject("Task has been changed on the server, please reload and try again")}).then(function(e){console.debug("updateTaskObject: calendar updated");var t=e.getResponseHeader("etag");return t&&(i.obj.etag=t),o.cache.update(i),i})},BackendDav.prototype.newUid=function(){return newGuid()},BackendDav.prototype.insert=function(e,t,n){var o=this;console.debug("BackendDav.insert:",arguments);var s=this.findCalendar(n);if(!s)return Promise.reject("Task list not found: "+n);var a=new ICAL.Component("vcalendar");a.updatePropertyWithValue("version","2.0"),a.updatePropertyWithValue("prodid","github.com/himselfv/tasks-ig");var i=this.newUid(),d=new ICAL.Component("vtodo",a);d.updatePropertyWithValue("uid",i),a.addSubcomponent(d),this.updateTodoObject(d,e),d.updatePropertyWithValue("created",d.getFirstPropertyValue("last-modified")),d.updatePropertyWithValue("sequence",1);var r=null;r="undefined"==typeof t?Promise.resolve():this.choosePosition(e.parent,t,n).then(function(e){d.updatePropertyWithValue("x-apple-sort-order",e)});var l=null;return r.then(function(){console.debug("insert:",d),l=a.toString(),console.debug("insert.data: ",l)}).then(function(){return o.insertTodoObject(s,l,i+".ics")}).then(function(){return o.get(i,n)}).then(function(e){return o.cache.add(e),e})},BackendDav.prototype.insertTodoObject=function(e,t,n){return"string"!=typeof t&&t.obj&&(!n&&(n=t.id+".ics"),t=t.obj.calendarData),dav.createCalendarObject(e,{data:t,filename:n,xhr:this.xhr})},BackendDav.prototype["delete"]=function(e,t){var n=this;Array.isArray(e)||(e=[e]),console.debug("Dav.delete:",e,t);var o=this.findCalendar(t);return o?this.cachedGet(e,t).then(function(e){var t=[];for(var o in e)console.assert(e[o].obj),t.push(dav.deleteCalendarObject(e[o].obj,{xhr:n.xhr}));return Promise.all(t)}).then(function(){n.cache["delete"](e)}):Promise.reject("Task list not found: "+t)},BackendDav.prototype.moveToList=function(e,t,n){var o=this;return(console.log("BackendDav.moveToList"),n&&!(n instanceof BackendDav))?Backend.prototype.moveToList.call(this,e,t,n):(n||(n=this),this.getAllChildren(e,this.selectedTaskList).then(function(t){return t.unshift(e),t}).then(function(e){return n==o?o.moveToList_localDav(e,t):o.moveToList_foreignDav(e,t,n)}).then(function(){return n.patch({id:toTaskId(e),parent:null,position:n.newDownmostPosition()},t)}))},BackendDav.prototype.moveToList_foreignDav=function(e,t,n){var o=this;if(console.log("moveToList_foreignDav",arguments),isArrayEmpty(e))return Promise.resolve();for(var s=0;s<e.length;s++)e[s].id&&(e[s]=e[s].id);return this.get(e).then(function(e){for(var t=[],o=0;o<e.length;o++)t.push(n.insertTodoObject(e[o]));return Promise.all(t)}).then(function(){console.log("Moved to a different DAV list, deleting here"),o["delete"](e)})},BackendDav.prototype.moveToList_localDav=function(e,t){var n=this;if(console.log("moveToList_localDav",arguments),isArrayEmpty(e))return Promise.resolve();var o=this.findCalendar(t);if(!o)return Promise.reject("Task list not found: "+t);for(var s=[],a=0;a<e.length;a++){e[a].id||(e[a]=this.cache.get(e[a]));var d=e[a].obj.url,r=o.url+e[a].id+".ics";console.log(d," -> ",r),s.push(this.davMoveRequest("MOVE",d,r,{xhr:this.xhr}))}return Promise.all(s).then(function(){n.cache["delete"](toTaskIds(e))})},BackendDav.prototype.davMoveRequest=function(e,t,n,o){console.debug("davMoveRequest",arguments);var s=new dav.Request({method:e,requestData:null,transformRequest:function transformRequest(e){dav.request.setRequestHeaders(e,o),e.setRequestHeader("Destination",n)}});return console.debug("davMoveRequest: ",s),o.xhr.send(s,t,{sandbox:o.sandbox})}},{"./backend.js":1,"./utils.js":8}],3:[function(e,t,n){'use strict';function BackendGTasks(){Backend.call(this)}function isChromeExtension(){return"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.id&&"undefined"==typeof browser}function insertGoogleAPIs(){return loadScript("googleAPIscripts","https://apis.google.com/js/api.js")}function gapiLoad(){return console.log("loading gapi"),new Promise(function(e,t){gapi.load("client:auth2",{callback:function callback(){return e(gapi)},onerror:function onerror(e){console.log("gapi load fail:",e),t("GAPI client failed to load")}})})}function gapiUnwrapError(e){return!e||!e.error?e:e.error}function chromeGetAuthToken(){return new Promise(function(e,t){return chrome.identity.getAuthToken({interactive:!0},function(n){chrome.runtime.lastError&&t(chrome.runtime.lastError),e(n)})})}"undefined"!=typeof e&&(e("./utils.js").importSelf(),importAll(e("./backend.js")));var o=new Unit("undefined"!=typeof n&&n);inherit(Backend,BackendGTasks),o["export"](BackendGTasks);var s=["https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest"];document.URL.startsWith("moz-extension://")||registerBackend(BackendGTasks,"Google Tasks"),BackendGTasks.prototype.init=function(){var e=this;return insertGoogleAPIs().then(function(){return e.gapi=gapi,gapiLoad()})["catch"](function(e){throw gapiUnwrapError(e)})},BackendGTasks.prototype.getHardcodedParams=function(){return"undefined"!=typeof GTASKS_CLIENT_ID&&""!=GTASKS_CLIENT_ID&&"undefined"!=typeof GTASKS_API_KEY&&""!=GTASKS_API_KEY?{clientId:GTASKS_CLIENT_ID,apiKey:GTASKS_API_KEY}:null},BackendGTasks.prototype.settingsPage=function(){return isChromeExtension()?null:this.getHardcodedParams()?(console.log("BackendGt: Using hardcoded ClientID/API Key"),null):{intro:{title:"",hint:"Google requires a Client ID and API Key for your Tasks-IG instance to access Tasks programmatically.See:<ul><li><a href=https://developers.google.com/tasks/firstapp>How to register</a></li><li><a href=https://console.developers.google.com/cloud-resource-manager>Developer console</a></li></ul>Or use Tasks-IG instance from someone who already did."},clientId:{title:"Client ID",type:"text"},apiKey:{title:"API Key",type:"text"}}},BackendGTasks.prototype.clientLogin=function(e){return isChromeExtension()?this.chromeClientLogin():(e&&(e.clientId||e.apiKey)||(e=this.getHardcodedParams()),e&&e.clientId&&e.apiKey?this.gapi.client.init({discoveryDocs:s,clientId:e.clientId,apiKey:e.apiKey,scope:"https://www.googleapis.com/auth/tasks.readonly https://www.googleapis.com/auth/tasks"}):Promise.reject("Google ClientID or API Key not set"))},BackendGTasks.prototype.signin=function(e){var t=this;return this.clientLogin(e).then(function(){t._initialized=!0,isChromeExtension()||t.gapi.auth2.getAuthInstance().isSignedIn.listen(t.notifySignInStatus);var e=t.isSignedIn();if(t.notifySignInStatus(e),!e&&!isChromeExtension())return t.gapi.auth2.getAuthInstance().signIn()})["catch"](function(e){throw gapiUnwrapError(e)}).then(function(){return e})},BackendGTasks.prototype.signout=function(){return isChromeExtension()?void this.chromeSignOut():this.gapi.auth2.getAuthInstance().signOut()},BackendGTasks.prototype.notifySignInStatus=function(e){var t=this,n=null;n=e?this.getUserEmail():Promise.resolve(null),n.then(function(n){t.userEmail=n,Backend.prototype.notifySignInStatus.call(t,e)})},BackendGTasks.prototype.isSignedIn=function(){return isChromeExtension()?this.chromeIsSignedIn():!!this._initialized&&this.gapi.auth2.getAuthInstance().isSignedIn.get()},BackendGTasks.prototype.getUserEmail=function(){if(!this.isSignedIn())return Promise.resolve();if(isChromeExtension())return this.chromeGetUserEmail();var e=this.gapi.auth2.getAuthInstance(),t=e.currentUser.get().getBasicProfile();return t?Promise.resolve(t.getEmail()):Promise.resolve()},BackendGTasks.prototype.autoName=function(){var e=Backend.prototype.autoName.call(this);return this.isSignedIn()&&!!this.userEmail&&(e=e+" ("+this.userEmail+")"),e},BackendGTasks.prototype.chromeClientLogin=function(){var e=this;return chromeGetAuthToken().then(function(t){e.chromeAuthToken=t,e.gapi.client.setToken({access_token:t});var n=chrome.runtime.getManifest().tasks_api_key;return e.gapi.client.init({apiKey:n,discoveryDocs:s})})},BackendGTasks.prototype.chromeGetUserEmail=function(){return new Promise(function(e){chrome.identity.getProfileUserInfo||e(),console.log("BackendGTasks: will try to get chrome user info"),chrome.identity.getProfileUserInfo(null,function(t){console.log("BackendGTasks: got chrome user info",t),!t||!t.email?e():e(t.email)})})},BackendGTasks.prototype.chromeSignIn=function(){this.notifySignInStatus(!0)},BackendGTasks.prototype.chromeIsSignedIn=function(){return!!this.chromeAuthToken},BackendGTasks.prototype.chromeSignOut=function(){delete this.chromeAuthToken,this.notifySignInStatus(!1)},BackendGTasks.prototype.responseCheck=function(e){if(!e.status||200>e.status||299<e.status)throw e},BackendGTasks.prototype.batchResponseCheck=function(e){var t=this;Object.keys(e.result).forEach(function(n){t.responseCheck(e.result[n])})},BackendGTasks.prototype._listPaged=function(e,t){var n=this,o=[],s=function nextPage(s){return(n.responseCheck(s),!s.result.items)?o:(o=o.concat(s.result.items),s.result.items.length<t.maxResults||!s.result.nextPageToken)?o:(t.pageToken=s.result.nextPageToken,e(t).then(function(e){return nextPage(e)}))};return e(t).then(function(e){return s(e)})},BackendGTasks.prototype.tasklistList=function(){return this._listPaged(this.gapi.client.tasks.tasklists.list.bind(this.gapi.client.tasks.tasklists),{maxResults:100})},BackendGTasks.prototype.tasklistAdd=function(e){var t=this;return this.gapi.client.tasks.tasklists.insert({resource:{title:e}}).then(function(e){return t.responseCheck(e),e.result})},BackendGTasks.prototype.tasklistGet=function(e){var t=this;return this.gapi.client.tasks.tasklists.get({tasklist:e}).then(function(e){return t.responseCheck(e),e.result})},BackendGTasks.prototype.tasklistUpdate=function(e){var t=this;return this.gapi.client.tasks.tasklists.update({tasklist:e.id,resource:e}).then(function(e){return t.responseCheck(e),e.result})},BackendGTasks.prototype.tasklistDelete=function(e){var t=this;return this.gapi.client.tasks.tasklists["delete"]({tasklist:e}).then(function(e){return t.responseCheck(e),e.result})},BackendGTasks.prototype.TASK_FIELDS=["kind","id","etag","selfLink","title","notes","status","parent","position","updated","completed","due","deleted","hidden","links"],BackendGTasks.prototype.taskToResource=function(e){var t=Backend.prototype.taskToResource.call(this,e);return"undefined"!=typeof t.status&&"completed"!=t.status&&(t.status="needsAction"),t.completed instanceof Date&&(t.completed=t.completed.toISOString()),t.due instanceof Date&&(t.due=t.due.toISOString()),t},BackendGTasks.prototype.resourceToTask=function(e){var t=Backend.prototype.resourceToTask.call(this,e);return t.completed=maybeStrToDate(t.completed),t.due=maybeStrToDate(t.due),t.updated=maybeStrToDate(t.updated),t},BackendGTasks.prototype.list=function(e){var t="id,title,parent,position,notes,status,due,completed";return this.showDeleted&&(t+=",deleted"),this._listPaged(this.gapi.client.tasks.tasks.list.bind(this.gapi.client.tasks.tasks),{tasklist:e,maxResults:100,showCompleted:!0,showHidden:!0,showDeleted:this.showDeleted,fields:"items("+t+"),nextPageToken"})},BackendGTasks.prototype.getOne=function(e,t){var n=this;return t||(t=this.selectedTaskList),this.gapi.client.tasks.tasks.get({tasklist:t,task:e}).then(function(e){return n.responseCheck(e),n.resourceToTask(e.result)})},BackendGTasks.prototype.getMultiple=function(e,t){var n=this;t||(t=this.selectedTaskList);var o=this.gapi.client.newBatch();return e.forEach(function(e){return o.add(n.gapi.client.tasks.tasks.get({tasklist:t,task:e}))}),o.then(function(e){var t={};return Object.keys(e.result).forEach(function(o){var s=e.result[o];n.responseCheck(s),t[s.result.id]=n.resourceToTask(s.result)}),t})},BackendGTasks.prototype.update=function(e,t){var n=this;return t||(t=this.selectedTaskList),this.gapi.client.tasks.tasks.update({tasklist:t,task:e.id,resource:this.taskToResource(e)}).then(function(t){return n.responseCheck(t),n.cache.update(e),n.resourceToTask(t.result)})},BackendGTasks.prototype.insert=function(e,t,n){var o=this;return this.gapi.client.tasks.tasks.insert({tasklist:n,parent:e.parent,previous:t,resource:this.taskToResource(e)}).then(function(e){return o.responseCheck(e),n==o.selectedTaskList&&o.cache.add(e.result),o.resourceToTask(e.result)})},BackendGTasks.prototype.insertMultiple=function(e,t){var n=this;if(0>=e.length)return Promise.resolve({});if(1==e.length)return this.insert(e[0],e[0].previousId,t);var o=this.gapi.client.newBatch();for(var s in e)o.add(this.gapi.client.tasks.tasks.insert({tasklist:t,parent:e[s].parent,previous:e[s].previousId,resource:this.taskToResource(e[s])}),{id:s});return o.then(function(e){var o={};for(var s in e.result)n.responseCheck(e.result[s]),o[s]=n.resourceToTask(e.result[s].result),t==n.selectedTaskList&&n.cache.add(e.result[s].result);return o})},BackendGTasks.prototype["delete"]=function(e,t){var n=this;e=toTaskIds(e);var o=this.gapi.client.newBatch();return e.forEach(function(e){o.add(n.gapi.client.tasks.tasks["delete"]({tasklist:t,task:e}))}),o.then(function(t){return n.batchResponseCheck(t),n.cache["delete"](e),t})},BackendGTasks.prototype.move=function(e,t,n){var o=this;if(e=toArray(e),isEmpty(e))return Promise.resolve();var s=[];e.reverse().forEach(function(e){var a={tasklist:o.selectedTaskList,task:e};t&&(a.parent=t),n&&(a.previous=n),s.push(o.gapi.client.tasks.tasks.move(a))});var a=null;if(1>=e.length)a=s[0].then(function(t){var n={};return n[e[0]]=t,{result:n}});else{a=this.gapi.client.newBatch();for(var d=0;d<s.length;d++)a.add(s[d])}return a=a.then(function(e){Object.keys(e.result).forEach(function(n){var s=e.result[n];o.responseCheck(s),o.cache.patch({id:s.result.id,parent:t,position:s.result.position,etag:s.result.etag,updated:s.result.updated})})}),a}},{"./backend.js":1,"./utils.js":8}],4:[function(t,n,o){'use strict';function _typeof(e){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(e){return typeof e}:function _typeof(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function BackendLocal(){Backend.call(this),this.STORAGE_PREFIX="tasksIg_backend_"}function BackendLocalStorage(){BackendLocal.call(this),window.addEventListener("storage",this.localStorageChanged.bind(this)),this.storage=window.localStorage}function BackendSessionStorage(){BackendLocalStorage.call(this),this.storage=window.sessionStorage}function BackendBrowserStorage(e){var t=this;BackendLocal.call(this),this.areaName=e,"sync"==e?this.storage=getBrowserStorageSync():"local"==e&&(this.storage=getBrowserStorageLocal()),getBrowserStorage().onChanged.addListener(function(e,n){return t.backendStorageChanged(e,n)})}function getBrowserStorage(){return"undefined"==typeof browser?"undefined"==typeof chrome?null:chrome.storage:browser.storage}function getBrowserStorageSync(){var e=getBrowserStorage();return e?"undefined"==typeof browser?"undefined"==typeof chrome?null:new ChromeStorageWrapper(e.sync):e.sync:null}function getBrowserStorageLocal(){var e=getBrowserStorage();return e?"undefined"==typeof browser?"undefined"==typeof chrome?null:new ChromeStorageWrapper(e.local):e.local:null}function ChromeStorageWrapper(e){this.storage=e}function BackendBrowserStorageSync(){BackendBrowserStorage.call(this,"sync")}function BackendBrowserStorageLocal(){BackendBrowserStorage.call(this,"local")}function TasklistEntry(e,t){this.id=e,this.parentId=t}function _tasklistToParentPrev(e){var t={},n={};return e?(e.forEach(function(e){var o=t[e.parentId];t[e.parentId]=e.id,n[e.id]={parentId:e.parentId,prevId:o}}),n):n}"undefined"!=typeof t&&(t("./utils.js").importSelf(),importAll(t("./backend.js")));var s=new Unit("undefined"!=typeof o&&o);inherit(Backend,BackendLocal),s["export"](BackendLocal),inherit(BackendLocal,BackendLocalStorage),s["export"](BackendLocalStorage),inherit(BackendLocalStorage,BackendSessionStorage),s["export"](BackendSessionStorage),inherit(BackendLocal,BackendBrowserStorage),s["export"](BackendBrowserStorage),ChromeStorageWrapper.prototype.get=function(e){var t=this;return new Promise(function(n,o){return t.storage.get(e,function(e){chrome.runtime.lastError&&o(chrome.runtime.lastError),n(e)})})},ChromeStorageWrapper.prototype.set=function(e){var t=this;return new Promise(function(n,o){return t.storage.set(e,function(){chrome.runtime.lastError&&o(chrome.runtime.lastError),n()})})},ChromeStorageWrapper.prototype.remove=function(e){var t=this;return new Promise(function(n,o){return t.storage.remove(e,function(){chrome.runtime.lastError&&o(chrome.runtime.lastError),n()})})},ChromeStorageWrapper.prototype.clear=function(){var e=this;return new Promise(function(t,n){return e.storage.clear(function(){chrome.runtime.lastError&&n(chrome.runtime.lastError),t()})})},inherit(BackendBrowserStorage,BackendBrowserStorageSync),inherit(BackendBrowserStorage,BackendBrowserStorageLocal),s["export"](BackendBrowserStorageSync),s["export"](BackendBrowserStorageLocal),getBrowserStorageSync()&&registerBackend(BackendBrowserStorageSync,"Browser storage (synced)"),getBrowserStorageLocal()?registerBackend(BackendBrowserStorageLocal,"Browser storage (local)"):registerBackend(BackendLocalStorage,"Local storage"),options&&options.debug&&registerBackend(BackendSessionStorage,"Session storage"),BackendLocalStorage.prototype._get=function(e){var t=this.storage.getItem(this.STORAGE_PREFIX+e);return Promise.resolve(t?JSON.parse(t):null)},BackendLocalStorage.prototype._set=function(e,t){return this.storage.setItem(this.STORAGE_PREFIX+e,JSON.stringify(t)),Promise.resolve()},BackendLocalStorage.prototype._remove=function(e){return this.storage.removeItem(this.STORAGE_PREFIX+e),Promise.resolve()},BackendLocalStorage.prototype.reset=function(){for(var e=this.storage.length-1,t;0<=e;e--)t=this.storage.key(e),t.startsWith(this.STORAGE_PREFIX)&&this.storage.removeItem(t);return Promise.resolve()},BackendLocalStorage.prototype.localStorageChanged=function(e){if(e.storageArea==this.storage){var t=e.key;t.startsWith(this.STORAGE_PREFIX)&&(t=t.slice(this.STORAGE_PREFIX.length),this.storageChanged(t,e.oldValue,e.newValue))}},BackendBrowserStorage.prototype._get=function(e){return this.storage.get(e).then(function(t){var n=t[e];return n?JSON.parse(n):null})},BackendBrowserStorage.prototype._set=function(e,t){var n={};return n[e]=JSON.stringify(t),this.storage.set(n).then(function(e){return e})},BackendBrowserStorage.prototype._remove=function(e){return this.storage.remove(e).then(function(e){return e})},BackendBrowserStorage.prototype.reset=function(){return this.storage.clear().then(function(e){return e})},BackendBrowserStorage.prototype.backendStorageChanged=function(e,t){var n=this;t!=this.areaName||Object.keys(e).forEach(function(t){var o=e[t];n.storageChanged(t,o.oldValue,o.newValue)})},BackendLocal.prototype._newId=function(){return new Date().toISOString()+e(1e3*Math.random())},BackendLocal.prototype._getTasklists=function(){return this._get("tasklists").then(function(e){return e||{}})},BackendLocal.prototype._setTasklists=function(e){if(!e)throw"_setTasklists: lists==undefined";return this._set("tasklists",e)},BackendLocal.prototype._getList=function(e){return this._get("list_"+e).then(function(t){return t?t:Promise.reject("Task list not found: "+e)})},BackendLocal.prototype._getListIds=function(e){return this._getList(e).then(function(e){var t=[];return e.forEach(function(e){return t.push(e.id)}),t})},BackendLocal.prototype._setList=function(e,t){if(!e||!t)throw"_setList: id="+e+", list="+t;return this._set("list_"+e,t)},BackendLocal.prototype._removeList=function(e){return this._remove("list_"+e)},BackendLocal.prototype._getItem=function(e){var t=this;return this._get("item_"+e).then(function(n){return n?t.resourceToTask(n):Promise.reject("Task not found: "+e)})},BackendLocal.prototype._setItem=function(e,t){if(!e||!t)throw"_setItem: id="+e+", item="+t;return this._set("item_"+e,t)},BackendLocal.prototype._removeItem=function(e){return this._remove("item_"+e)},BackendLocal.prototype.resourceToTask=function(e){var t=Backend.prototype.resourceToTask.call(this,e);return t.completed=maybeStrToDate(t.completed),t.due=maybeStrToDate(t.due),t.updated=maybeStrToDate(t.updated),t},BackendLocal.prototype.tasklistList=function(){return this._getTasklists().then(function(e){return Object.values(e)})},BackendLocal.prototype.tasklistAdd=function(e){var t=this,n=null;return this._getTasklists().then(function(o){return n={id:t._newId(),title:e},o[n.id]=n,t._setTasklists(o).then(function(){return t._setList(n.id,[])})}).then(function(){return n})},BackendLocal.prototype.tasklistGet=function(e){return this._getTasklists().then(function(t){return e in t?t[e]:Promise.reject("No such task list: "+(e+""))})},BackendLocal.prototype.tasklistUpdate=function(e){var t=this;return this._getTasklists().then(function(n){return e.id in n?(n[e.id]=e,t._setTasklists(n)):Promise.reject("No such task list: "+(e.id+""))}).then(function(){return e})},BackendLocal.prototype.tasklistDelete=function(e){var t=this;return this._getTasklists().then(function(n){return e in n?(delete n[e],Promise.all([t._setTasklists(n),t._removeList(e)])):Promise.reject("No such task list: "+(e+""))})},BackendLocal.prototype.list=function(e){var t=this;return this._getListIds(e).then(function(n){return t.get(n,e)}).then(function(e){e=Object.values(e);for(var t=0;t<e.length;t++)e[t].position=t;return e})},BackendLocal.prototype.getOne=function(e,t){var n=this;t||(t=this.selectedTaskList),e=toTaskId(e);var o=null;return this._getItem(e).then(function(e){return o=e,n._getListIds(t)}).then(function(t){return o.position=t.indexOf(e),0>o.position?Promise.reject("Task not found in the given list"):o})},BackendLocal.prototype.update=function(e,t){var n=this;t||(t=this.selectedTaskList);var o=this._getListIds(t).then(function(t){if(!t.includes(e.id))return Promise.reject("update(): No such task in the current list");var o=n.taskToResource(e);return n.cache.update(e,o),n._setItem(e.id,o)});return o.then(function(){return e})},BackendLocal.prototype.insert=function(e,t,n){var o=this,s=this._getList(n).then(function(s){var a=0;if(t){if(a=s.findIndex(function(e){return e.id==t}),0>a)return Promise.reject("insert(): No previous task in the current list");a+=1}e.id=o._newId();var i=o.taskToResource(e);return s.splice(a,0,new TasklistEntry(e.id,e.parent)),n==o.selectedTaskList&&o.cache.add(i),Promise.all([o._setList(n,s),o._setItem(e.id,i)])});return s.then(function(){return e})},BackendLocal.prototype["delete"]=function(e,t){var n=this;return e=toTaskIds(e),this._getList(t).then(function(o){for(var s=function _loop(t){var s=e[t],a=o.findIndex(function(e){return e.id==s});return 0>a?{v:Promise.reject("delete(): No such task in the given list")}:void(o.splice(a,1),n._removeItem(s))},a=0,d;a<e.length;a++)if(d=s(a),"object"===_typeof(d))return d.v;return n._setList(t,o)}).then(function(){n.cache["delete"](e)})},BackendLocal.prototype._moveOne=function(e,t,n){var o=this;e&&e.id&&(e=e.id),t&&t.id&&(t=t.id),n&&n.id&&(n=n.id);var s=null,a=Promise.all([this._getList(this.selectedTaskList),this._getItem(e)]).then(function(a){var i=a[0];s=a[1];var d=i.findIndex(function(t){return t.id==e});if(0>d)return Promise.reject("move(): No such task in the given list");var r=0;if(n){if(r=i.findIndex(function(e){return e.id==n}),0>r)return Promise.reject("move(): No given previous task in the given list");r+=1}return i.splice(d,1),d<=r&&r--,i.splice(r,0,new TasklistEntry(e,t)),s.parent=t,o.cache.patch({id:e,parent:t}),Promise.all([o._setList(o.selectedTaskList,i),o._setItem(e,s)])});return a.then(function(){return s})},BackendLocal.prototype.moveToList=function(e,t,n){var o=this;if(console.debug("BackendLocal.moveToList:",arguments),n&&!(n instanceof BackendLocal))return Backend.prototype.moveToList.call(this,e,t,n);if(n||(n=this),!t||t==this.selectedTaskList)return Promise.resolve();e&&e.id&&(e=e.id);var s=this.selectedTaskList,a=[e],i=null,d=this.getAllChildren(e,s).then(function(n){return n&&n.forEach(function(e){return a.push(e.id)}),Promise.all([o._getList(s),o._getList(t),o._getItem(e)])}).then(function(n){var d=n[0],r=n[1];i=n[2];var l=0;return a.forEach(function(e){var t=d.findIndex(function(t){return t.id==e});if(0>t)return Promise.reject("moveToList(): Task not found in a source list");var n=d.splice(t,1).shift();n.id==e&&(n.parentId=null),r.splice(l,0,n),l+=1,o.cache["delete"]({id:e})}),i.parent=null,Promise.all([o._setList(t,r),o._setList(s,d),o._setItem(e,i)])});return d.then(function(){return i})},BackendLocal.prototype.storageChanged=function(e,t,n){var o=this;if(console.debug("storageChanged: ",e,": ",t,"->",n),"tasklists"==e){var s=diffDict(JSON.parse(t),JSON.parse(n),function(e,t){return e.id==t.id&&e.title==t.title});Object.keys(s).forEach(function(e){var t=s[e];t.oldValue?t.newValue?o.onTasklistEdited.notify(t.newValue):o.onTasklistDeleted.notify(e):o.onTasklistAdded.notify(t.newValue)})}else if(e.startsWith("list_")){e=e.slice(5);var a=_tasklistToParentPrev(JSON.parse(t)),i=_tasklistToParentPrev(JSON.parse(n)),d=diffDict(a,i,function(e,t){return e.parentId==t.parentId&&e.prevId==t.prevId});Object.keys(d).forEach(function(t){var n=d[t];n.oldValue&&n.newValue&&o.onTaskMoved.notify(t,{tasklistId:e,parentId:n.newValue.parentId,prevId:n.newValue.prevId})})}else e.startsWith("item_")&&(e=e.slice(5),n?t?this.onTaskEdited.notify(JSON.parse(n)):this.taskFindTasklist(e).then(function(e){o.onTaskAdded.notify(JSON.parse(n),e)}):this.onTaskDeleted.notify(e))},BackendLocal.prototype.taskFindTasklist=function(e){var t=this,n=[];return this._getTasklists().then(function(e){n=Object.keys(e);var o=[];return n.forEach(function(e){return o.push(t._getList(e))}),Promise.all(o)}).then(function(t){for(var o=0;o<n.length;o++)if(t[o].find(function(t){return t.id==e}))return n[o];return null})}},{"./backend.js":1,"./utils.js":8}],5:[function(e,t,n){'use strict';function _createForOfIteratorHelper(e,t){var a;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(a=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){a&&(e=a);var s=0,n=function F(){};return{s:n,n:function n(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var d=!0,r=!1,l;return{s:function s(){a=e[Symbol.iterator]()},n:function n(){var e=a.next();return d=e.done,e},e:function e(t){r=!0,l=t},f:function f(){try{d||null==a["return"]||a["return"]()}finally{if(r)throw l}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}"undefined"!=typeof e&&(e("./utils.js").importSelf(),importAll(e("./backend.js")),importAll(e("./backendLocal.js")));var o=new Unit("undefined"!=typeof n&&n);if(options.debug){var s=function BackendTestBase(){Backend.call(this)},a=function newTestBackend(e,t,n){options.debug&&(inheritBackend(e,t),registerBackend(t,n),o["export"](t),"undefined"!=typeof window&&(window[t.name]=t))},i=function BackendFailInit(){s.call(this)},d=function BackendNeverInit(){s.call(this)},r=function BackendLongInit(){s.call(this)},l=function BackendFailLoadScripts(){s.call(this)},p=function BackendFailSignout(){s.call(this)},c=function BackendDisconnectsAfterAWhile(){s.call(this)},u=function BackendSettingsTest(){s.call(this)},g=function BackendLocalStorageRO(){BackendLocalStorage.call(this)},h=function BackendFailEverything(){g.call(this)},y=function BackendTestDeletedFlag(){BackendLocalStorage.call(this)};if(inheritBackend(Backend,s),o["export"](s),s.prototype.tasklistList=function(){return Promise.resolve([])},a(s,i,"Fail init"),i.prototype.init=function(){return .5>Math.random()?Promise.reject("Sorry but I failed init()"):Promise.resolve()},a(s,d,"Never init"),d.prototype.init=function(){return .5>Math.random()?new Promise(function(){}):Promise.resolve()},a(s,r,"Long init"),r.prototype.init=function(){return new Promise(function(e){return setTimeout(e,5e3)})},a(s,l,"Fail load scripts"),l.prototype.init=function(){return loadScripts({nonexistingScript:"nonexistingScript.js"})},a(s,p,"Fail sign-out"),p.prototype.signout=function(){return Promise.reject("Sorry, I failed signout")},a(s,c,"Disconnect after a while"),c.prototype.init=function(){var e=this;return setTimeout(function(){return e.signout.bind(e)},5e3),Promise.resolve()},.5>Math.random()){var k=function BackendDoesNotRegister(){s.call(this)};console.log("registered"),a(s,k,"Does not register")}a(s,u,"Settings test"),u.prototype.settingsPage=function(){return{textTest:{type:"text"},passwordTest:{type:"password"},numberTest:{type:"number"},boolTest:{type:"bool"},listTest:{type:["Option 1","Option 2","Option 3"]},customTitleTest:{type:"text",title:"Custom title"},defaultTextTest:{type:"text",default:"default text value"},defaultPasswordTest:{type:"password",default:"default password value"},defaultNumberValue:{type:"number",default:1234},defaultBoolValue:{type:"bool",default:!0},defaultListValue:{type:["Option 1","Option 2","Option 3"],default:"Option 2"},descTest:{type:"text",hint:"Setting description, can contain <b>HTML</b> <i>tags</i>."},noneTypeTest:{title:"",hint:"Null types should have no input fields, only show the title and the description. The default value should still be passed.",default:"noneTypeTestDefaultValue"},actuallySignin:{type:"bool",hint:"Set this to true for the backend to accept your signin"}}},u.prototype.signin=function(e){return console.log("BackendSettingsTest.signin:",e),e&&e.actuallySignin?this.__proto__.__proto__.signin.call(this,e):(console.log("no"),Promise.reject("BackendSettingsTest: Values passed to signin() are available in the console. Set 'actuallySignin' to true to sign in."))},a(BackendLocalStorage,g,"Local Storage (RO)"),g.prototype.reset=null,g.prototype.update=null,g.prototype.insert=null,g.prototype["delete"]=null,g.prototype._moveOne=null,g.prototype.moveToList=null,g.prototype.tasklistAdd=null,g.prototype.tasklistUpdate=null,g.prototype.tasklistDelete=null,a(g,h,"Fail everything"),h.prototype._fail=function(){return Promise.reject("Backend tried but failed")},h.prototype.reset=h.prototype._fail,h.prototype.update=h.prototype._fail,h.prototype.insert=h.prototype._fail,h.prototype["delete"]=h.prototype._fail,h.prototype._moveOne=h.prototype._fail,h.prototype.moveToList=h.prototype._fail,h.prototype.tasklistAdd=h.prototype._fail,h.prototype.tasklistUpdate=h.prototype._fail,h.prototype.tasklistDelete=h.prototype._fail,a(BackendLocalStorage,y,"Test deleted flag"),y.prototype["delete"]=function(e){e=toTaskIds(e);var t=[],n=_createForOfIteratorHelper(e),o;try{for(n.s();!(o=n.n()).done;){var s=o.value;t.push(this.patch({id:s,deleted:!0}))}}catch(e){n.e(e)}finally{n.f()}return Promise.all(t)}}},{"./backend.js":1,"./backendLocal.js":4,"./utils.js":8}],6:[function(e,t,n){'use strict';function asyncGeneratorStep(e,t,n,o,s,a,i){try{var d=e[a](i),r=d.value}catch(e){return void n(e)}d.done?t(r):Promise.resolve(r).then(o,s)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise(function(o,s){function _next(e){asyncGeneratorStep(a,o,s,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep(a,o,s,_next,_throw,"throw",e)}var a=e.apply(t,n);_next(void 0)})}}function _createForOfIteratorHelper(e,t){var a;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(a=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){a&&(e=a);var s=0,n=function F(){};return{s:n,n:function n(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var d=!0,r=!1,l;return{s:function s(){a=e[Symbol.iterator]()},n:function n(){var e=a.next();return d=e.done,e},e:function e(t){r=!0,l=t},f:function f(){try{d||null==a["return"]||a["return"]()}finally{if(r)throw l}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}function optionsPageOpen(){console.debug("options:",options);var e=new SettingsPage("Options",d,options);e.addEventListener("ok",function(t){options=t.results,optionsSave(),e.resolve()})}function printError(e){console.log(e),"string"!=typeof e&&(e=JSON.stringify(e));var t=document.getElementById("errorPopup"),n=t.innerText;""!=n&&(n+="\r\n"),t.innerText=n+e,t.classList.remove("hidden"),document.getElementById("activityIndicator").classList.toggle("error",!0),r=!0}function newJob(){return l.waitCurrentJobsCompleted()}function pushJob(e){return"function"==typeof e?l.push(newJob().then(function(){return e()})):l.push(e)}function addIdleJob(e){return l.addIdleJob(e)}function handleBeforeUnload(e){var t="";return r?t="Some changes to your tasks might have failed.":(1<=l.count||0<l.idlePromises.length)&&(t="Some changes to your tasks are still pending. If you close the page now they may be lost"),t&&(e.preventDefault(),e.returnValue=t),t}function registerChangeNotifications(e){e.onTasklistAdded.push(function(){p.tasklists=!0,addIdleJob(processReportedChanges)}),e.onTasklistEdited.push(function(){p.tasklists=!0,addIdleJob(processReportedChanges)}),e.onTasklistDeleted.push(function(){p.tasklists=!0,addIdleJob(processReportedChanges)}),e.onTaskAdded.push(function(e){p.tasks.push(e.id),addIdleJob(processReportedChanges)}),e.onTaskEdited.push(function(e){p.tasks.push(e.id),addIdleJob(processReportedChanges)}),e.onTaskDeleted.push(function(e){p.tasks.push(e),addIdleJob(processReportedChanges)}),e.onTaskMoved.push(function(e){p.tasks.push(e),addIdleJob(processReportedChanges)})}function processReportedChanges(){var e=Promise.resolve();p.tasklists&&(e=e.then(function(){return c.reloadTasklists(y)}));var t=selectedTaskList();t||(p.tasks=[]),0<p.tasks.length&&(e=e.then(function(){return tasklistReloadSelected()})),pushJob(e)}function backendCreate(e){if("string"==typeof e){var t=window[e];if(!t)throw"Backend not found: "+e;e=t}if(console.log("Initializing backend:",e.name),y=new e,!y)throw"Cannot create backend "+e.name;return y.showDeleted=options.showDeleted,y.ui={},y.onSignInStatus.push(c.signinStatusChanged.bind(c)),registerChangeNotifications(y),y}function backendCreateDummy(e,t){var n=new DummyBackend(e,t);return n.error=t,n.ui={},n}function Accounts(){var e=this;this.setupEventTarget(),this.list=[],Object.defineProperty(this,"length",{enumerable:!1,get:function get(){return e.list.length},set:function set(t){e.list.length=t}})}function accountListChanged(){s.classList.toggle("hidden",0>=c.length),0>=c.length&&(v.cancel(),k.clear(),StartNewAccountUi({hasCancel:!1}),console.debug("accountListChanged: no accounts, tasklistBoxReload() to empty"))}function accountStateChanged(e){var t=selectedTaskList();console.debug("accountStateChanged",e),u.reload(),g.reload();var n=selectedTaskList();n+""==t+""&&n.account==e&&(n.tasklist?accountActionsUpdate():(console.debug("accountStateChanged: !newSelected.tasklist"),accountPageReload(n)))}function AccountsPage(){CustomPage.call(this,document.getElementById("accountsPage")),this.content=new TaskListPanel(document.getElementById("accountList")),this.content.showAccounts=!0,this.content.selectAccounts=!0,this.content.showLists=!1,this.content.addEventListener("change",this.updateAccountActions.bind(this)),document.getElementById("accountListClose").onclick=this.cancelClick.bind(this),document.getElementById("accountListAdd").onclick=this.addClick.bind(this),document.getElementById("accountListRename").onclick=this.renameClick.bind(this),document.getElementById("accountListEditSettings").onclick=this.editSettingsClick.bind(this),document.getElementById("accountListDelete").onclick=this.deleteClick.bind(this),document.getElementById("accountListReset").onclick=this.resetClick.bind(this),document.getElementById("accountListMoveUp").onclick=this.moveUpClick.bind(this),document.getElementById("accountListMoveDown").onclick=this.moveDownClick.bind(this),document.getElementById("accountListReset").classList.toggle("hidden",!options.debug),this.page.classList.remove("hidden"),this.reload()}function StartNewAccountUi(e){e.prompt="Access tasks in:";var t=new BackendSelectPage(e);return t.addEventListener("ok",function(e){t.resolve(e.results)}),t.waitResult()}function accountAdd(){return StartNewAccountUi({hasCancel:!0})}function accountDelete(e){if(!confirm("Do you really want to sign out of the account "+e.uiName()+" and forget about it?"))return Promise.resolve(!1);var t=!0;return e.signout()["catch"](function(n){confirm("Cannot properly sign out of the account \""+e.uiName()+"\":\r\n\""+n+"\"\r\n\r\nForget it anyway?")||(t=!1)}).then(function(){return t&&c["delete"](e.id),t})}function accountReset(e){return e||(e=y),e&&e.reset?confirm("WARNING. This will delete all your tasks and task lists and RESET this account:\r\n\r\n"+e.uiName()+"\r\n\r\nDo you want to continue?")?confirm("Are you SURE you want to delete ALL your task lists and tasks in account \""+e.uiName()+"\"?")?pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee(){return regeneratorRuntime.wrap(function _callee$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.reset();case 2:c.reloadTasklists(e);case 3:case"end":return t.stop();}},_callee)}))):void 0:void 0:void 0}function accountRename(e){if(e||(e=y),!!e){var t=e.uiName()+"",n=t;e.autoName()!=t&&(n+=" ("+(e.autoName()+")"));var o=prompt("Enter new name for account "+(n+""),t);return o&&o!=t?Promise.resolve(c.rename(e,o)):void 0}}function accountEditSettings(e){return e||(e=y),alert("At the moment, please delete and re-add the account to change its settings"),Promise.resolve()}function BackendSelectPage(e){console.debug("BackendSelectPage()",e),CustomPage.call(this,document.getElementById("backendSelectPage")),this.hasCancel=e.hasCancel,this.prompt=e.prompt,this.content=this.page.firstElementChild,this.reenable(),this.reload(),this.page.classList.remove("hidden")}function SettingsPage(e,t,n){console.log("SettingsPage()",arguments),CustomPage.call(this,document.getElementById("settingsPage")),this.btnOk=document.getElementById("settingsOk"),this.btnCancel=document.getElementById("settingsCancel"),this.btnOk.onclick=this.okClick.bind(this,null),this.btnCancel.onclick=this.cancelClick.bind(this),this.content=document.getElementById("settingsContent");var o=document.getElementById("settingsPageTitle");o.textContent=e,this.reload(t),n&&this.setValues(n),this.page.classList.remove("hidden"),this.reenable()}function BackendSettingsPage(e,t,n){console.log("BackendSettingsPage:",arguments),e||(e="Connection"),SettingsPage.call(this,e+" settings:",t,n)}function TaskListHandle(e,t){this.account=e,this.tasklist=t}function TaskListBox(e){var t=this;e||(e=document.createElement("select")),e.classList.toggle("taskListBox",!0),this.box=e,this.showAccounts=options.showAccountsInCombo,this.selectAccounts=options.accountsClickable,this.selectFailedAccounts=!1,c.addEventListener("change",function(){return t.reload()})}function MainTaskListBox(e){TaskListBox.call(this,e),this.selectFailedAccounts=!0,this.box.addEventListener("change",this._handleChanged.bind(this))}function urlSaveState(e){var t={};!e||!e.account||(t.a=e.account.id,e.tasklist&&(t.l=e.tasklist)),urlWrite(t)}function urlReadState(){var e=urlRead();if(!e||!("a"in e))return null;var t=c.find(e.a)||e.a,n=new TaskListHandle(t,e.l);return n}function TaskListPanel(e){var t=this;e||(e=document.createElement("div")),e.classList.toggle("tasklistPanel",!0),this.setupEventTarget(),this.box=e,this.showAccounts=!0,this.showLists=!0,this.selectAccounts=options.accountsClickable,this.selectFailedAccounts=!0,c.addEventListener("change",function(){return t.reload()}),this.dragMgr=new TaskListPanelDragMgr(this),this.dragMgr.autoShield=!0,this.dragMgr.dragTolerance=10,this.dragMgr.dragDelay=500}function TaskListPanelDragMgr(e){ItemDragMgr.call(this),this.parent=e}function MainTaskListPanel(e){TaskListPanel.call(this,e)}function selectedTaskList(){return u.selected()}function selectedTaskListTitle(){return u.selectedTitle()}function setSelectedTaskList(e,t){u.setSelected(e,t)}function selectedTaskListChanged(){console.debug("selectedTaskListChanged");var e=selectedTaskList();return g.setSelected(e),y=e&&e.account?e.account:null,accountActionsUpdate(),tasklistActionsUpdate(),tasklistReloadSelected()}function tasklistActionsUpdate(){var e=selectedTaskList();console.debug("tasklistActionsUpdate:",e,y),Actions.setDisabled(s,"listAdd",!y||!y.tasklistAdd),Actions.setDisabled(s,"listRename",!y||!y.tasklistUpdate||!e),Actions.setDisabled(s,"listDelete",!y||!y.tasklistDelete||!e),Actions.setDisabled(s,"tasksExportAllToFile",!e),tasksActionsUpdate()}function accountActionsUpdate(){console.debug("accountActionsUpdate",y),Actions.setDisabled(s,"accountReset",!y||!y.reset)}function tasklistInit(){k=new TaskList(document.getElementById("listContent")),k.addEventListener("focuschanged",tasksFocusChanged),k.addEventListener("dragstart",taskEntryDragStart),k.addEventListener("dragcommit",taskEntryDragCommit),k.addEventListener("titlechanged",taskEntryTitleChanged),k.addEventListener("titlefocusout",taskEntryTitleFocusOut),k.addEventListener("editclicked",taskEntryEditClicked),k.addEventListener("checked",taskEntryChecked),k.addEventListener("keydown",taskListKeyDown,{capture:!0})}function tasklistReloadSelected(){console.debug("tasklistReloadSelected");var e=k.getFocusedEntry();e&&(e={id:e.getId(),pos:e.getCaret()}),k.clear();var t=selectedTaskList();return y&&t?(console.debug("Loading list: ",t),y.selectTaskList&&y.selectTaskList(null),k.root.classList.toggle("hidden",!t.tasklist),accountPageReload(t),t.tasklist?y.selectTaskList(t.tasklist).then(function(t){if(k.clear(),k.appendTaskChildren(null,0,t),k.appendOrphans(t),e){var n=k.find(e.id);n&&n.setCaret(e.pos)}else tasksFocusChanged()}):Promise.resolve()):(console.debug("tasklistReloadSelected: no tasklist entry selected"),Promise.resolve())}function accountPageReload(e){console.debug("accountPageReload",e),"undefined"==typeof e&&(e=selectedTaskList());var t=document.getElementById("listAccountPage"),n=t.getElementsByTagName("div")[0];if(nodeRemoveAllChildren(n),!e||!e.account||!!e.tasklist)return void t.classList.toggle("hidden",!0);t.classList.remove("hidden");var o=e.account;if(o.error){var s=html.p("Could not initialize the backend "+e.account.uiName(),{class:"status"});return s.appendChild(html.br()),s.appendChild(html.text("Error: "+o.error)),n.appendChild(s),s=html.p(null,{class:"actions"}),void n.appendChild(html.li(linkNew(null,accountEditSettings,"Change account settings")))}if(!o.isSignedIn()||!o.ui||!o.ui.tasklists){var a=html.p("Signing in...",{class:"status"});return a.appendChild(html.br()),a.appendChild(html.text("If this takes too long, perhaps there are problems")),void n.appendChild(a)}var i=html.p(null,{class:"tasklists"});if(isArrayEmpty(o.ui.tasklists))i.textContent="No task lists in this account.";else{i.textContent="Task lists:";var d=function _loop2(e){var t=o.ui.tasklists[e];i.appendChild(html.li(linkNew(null,function(e){setSelectedTaskList(new TaskListHandle(o.id,t.id)),e.preventDefault()},t.title)))};for(var r in o.ui.tasklists)d(r)}o.tasklistAdd?i.appendChild(html.li(linkNew(null,tasklistAdd.bind(null,o),"Add a task list"))):i.appendChild(html.li("Task lists cannot be added to this account.")),n.appendChild(i),i=html.p(null,{class:"actions"}),i.appendChild(html.li(linkNew(null,accountEditSettings.bind(null,o),"Change account settings"))),options.debug&&o.reset&&i.appendChild(html.li(linkNew(null,accountReset.bind(null,o),"Reset account"))),n.appendChild(i)}function tasksFocusChanged(){tasksActionsUpdate()}function tasksActionsUpdate(){var e=selectedTaskList();console.debug("tasksActionUpdate:",e);var t=k.getFocusedEntry();Actions.setDisabled(s,"taskAdd",!y||!y.insert||!e.tasklist),Actions.setDisabled(s,"taskTab",!y||!y.move||!t),Actions.setDisabled(s,"taskShiftTab",!y||!y.move||!t),Actions.setDisabled(s,"taskMoveUp",!y||!y.move||!t),Actions.setDisabled(s,"taskMoveDown",!y||!y.move||!t),Actions.setDisabled(s,"taskEdit",!y||!t),Actions.setDisabled(s,"taskDelete",!y||!y["delete"]||!t),Actions.setDisabled(s,"taskDeleteRecursive",!y||!y.move||!t),Actions.setDisabled(s,"taskCopyJSON",!t),Actions.setDisabled(s,"taskExportToFile",!t),Actions.setDisabled(s,"tasksShowCompleted",!y||!e.tasklist),Actions.setDisabled(s,"tasksClearCompleted",!y||!e.tasklist||!y["delete"]),Actions.setDisabled(s,"tasksPrint",!y||!e.tasklist),Actions.setDisabled(s,"tasksRefresh",!y)}function taskEntryEdit(e){taskEntryTitleCommitNow(e),e.whenHaveId().then(function(e){return v.open(e)})}function taskEntryEditClicked(e){e.entry&&taskEntryEdit(e.entry)}function taskEntryEditFocused(){taskEntryEdit(k.getFocusedEntry())}function taskEntryChecked(e){var t={};return taskResSetCompleted(t,e.entry.getCompleted()),pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee2(){var n;return regeneratorRuntime.wrap(function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,taskEntryNeedIds([e.entry]);case 2:return n=o.sent,t.id=n[0],o.next=6,y.patch(t);case 6:return o.abrupt("return",o.sent);case 7:case"end":return o.stop();}},_callee2)})))}function taskEntryAddClicked(){taskEntryTitleCommitNow();var e=taskNewInCurrentList({},null,null);e.setCaret(0)}function taskEntryDeleteFocused(){var e=k.getFocusedEntry();e&&taskDelete(e,!1)}function taskEntryDeleteRecursiveFocused(){var e=k.getFocusedEntry();e&&taskDelete(e,!0)}function taskEntryExportToFile(){var e=k.getFocusedEntry();if(e){var t=e.getTitle();return pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee3(){var n,o;return regeneratorRuntime.wrap(function _callee3$(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,taskEntryNeedIds([e]);case 2:return n=s.sent,s.next=5,y.get(n[0]);case 5:return o=s.sent,s.abrupt("return",downloadAsJson(o,t));case 7:case"end":return s.stop();}},_callee3)})))}}function taskEntryCopyJSON(){var e=k.getFocusedEntry();if(e){var t=e.getId();if(!Object.prototype.hasOwnProperty.call(t,"taskId")){var n=y.cache.get(t);copyToClipboard(JSON.stringify(n))}}}function taskEntryExportAllToFile(){var e=k.allEntries(),t=selectedTaskListTitle();return pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee4(){var n,o;return regeneratorRuntime.wrap(function _callee4$(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,taskEntryNeedIds(e);case 2:return n=s.sent,s.next=5,y.get(n);case 5:return o=s.sent,s.abrupt("return",downloadAsJson(o,t));case 7:case"end":return s.stop();}},_callee4)})))}function tasklistClearCompleted(){if(y&&y["delete"]){var e=k.allEntries().filter(function(e){return e.getCompleted()});return 0>=e.length?void 0:confirm("Delete "+(e.length+" completed tasks from \"")+(selectedTaskListTitle()+"\"?"))?pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee5(){var t,n,o;return regeneratorRuntime.wrap(function _callee5$(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,taskEntryNeedIds(e);case 2:t=_createForOfIteratorHelper(e),s.prev=3,t.s();case 5:if((n=t.n()).done){s.next=11;break}return o=n.value,s.next=9,taskDelete(o,!1);case 9:s.next=5;break;case 11:s.next=16;break;case 13:s.prev=13,s.t0=s["catch"](3),t.e(s.t0);case 16:return s.prev=16,t.f(),s.finish(16);case 19:case"end":return s.stop();}},_callee5,null,[[3,13,16,19]])}))):void 0}}function filterShowCompleted(){}function tasklistLastTaskY(){var e=k.last();return e?relativeBoundingRect(e.node,e.node.parentNode).bottom:-1}function tasklistClick(e){options.singleClickAdd&&selectedTaskList()&&!(e.offsetY<=tasklistLastTaskY())&&taskEntryAddClicked(e)}function tasklistDblClick(e){e.offsetY<=tasklistLastTaskY()||!selectedTaskList()||taskEntryAddClicked(e)}function taskListKeyDown(e){var t=elementGetOwnerTaskEntry(e.target);if(t){if(e.ctrlKey)return void("ArrowUp"==e.key?(e.preventDefault(),taskMoveEntryUp(t)):"ArrowDown"==e.key&&(e.preventDefault(),taskMoveEntryDown(t)));if("Tab"==e.key&&(e.preventDefault(),e.shiftKey?taskEntryShiftTab(t):taskEntryTab(t)),!e.shiftKey)if("ArrowUp"==e.key){var n=t.getPrev();n&&(n.setCaret(t.getCaret()),e.preventDefault())}else if("ArrowDown"==e.key){var o=t.getNext();o&&(o.setCaret(t.getCaret()),e.preventDefault())}else if("ArrowLeft"==e.key){var s=t.getCaret();if(0===s){var a=t.getPrev();a&&(a.setCaret(a.getLength()),e.preventDefault())}}else if("ArrowRight"==e.key){var i=t.getCaret();if(i===t.getLength()){var d=t.getNext();d&&(d.setCaret(0),e.preventDefault())}}else if("Enter"==e.key){e.preventDefault();var r=t.getCaret();taskNewSplit(t,r)}else if("Delete"==e.key){var l=t.getCaret();!options.noMergeByDelete&&l==t.getLength()&&window.getSelection().isCollapsed&&(e.preventDefault(),taskMergeForward(t))}else if("Backspace"==e.key){var p=t.getCaret();!options.noMergeByBackspace&&0==p&&window.getSelection().isCollapsed&&(e.preventDefault(),taskMergeBackward(t))}}}function taskEntryTitleChanged(e){m&&m!=e.entry&&taskEntryTitleCommitNow(),m=e.entry,taskEntryTitleTriggerClear(),f=setTimeout(taskEntryTitleCommitNow,2e3),timeoutPromiseSet()}function taskEntryTitleFocusOut(e){taskEntryTitleCommitNow(e.entry)}function taskEntryTitleTriggerClear(){f&&(clearTimeout(f),f=null)}function taskEntryTitleCommitNow(e){if(!e)e=m;else if(e!=m)return;if(console.log("taskEntryTitleCommitNow"),taskEntryTitleTriggerClear(),!e)return void timeoutPromiseResolve();var t={};t.title=taskEntryNormalizeTitle(e.getTitle()),m=null,pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee6(){var n;return regeneratorRuntime.wrap(function _callee6$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,taskEntryNeedIds([e]);case 2:return n=o.sent,t.id=n[0],o.next=6,y.patch(t);case 6:return o.abrupt("return",o.sent);case 7:case"end":return o.stop();}},_callee6)}))),timeoutPromiseResolve()}function timeoutPromiseSet(){b||pushJob(new Promise(function(e){b=e}))}function timeoutPromiseResolve(){b&&(b(),b=null)}function taskEntryDragStart(e){y&&y.move||e.preventDefault()}function taskEntryDragCommit(e){var t=e.entry.getParent(),n=e.entry.getPreviousSibling();return pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee7(){var o;return regeneratorRuntime.wrap(function _callee7$(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,taskEntryNeedIds([e.entry,t,n]);case 2:return o=s.sent,s.next=5,y.move(o[0],o[1],o[2]);case 5:return s.abrupt("return",s.sent);case 6:case"end":return s.stop();}},_callee7)})))}function taskEntryTab(e){if(y&&y.move){taskEntryTitleCommitNow(e);var t=e.getPreviousSibling();if(!t)return void console.log("Already first sibling, can't shift right");var n=t.getLastDirectChild();return e.adjustLevel(1,!0),pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee8(){var o;return regeneratorRuntime.wrap(function _callee8$(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,taskEntryNeedIds([e,t,n]);case 2:return o=s.sent,s.next=5,y.move(o[0],o[1],o[2]);case 5:return s.abrupt("return",s.sent);case 6:case"end":return s.stop();}},_callee8)})))}}function taskEntryShiftTab(e){if(y&&y.move){if(taskEntryTitleCommitNow(e),0>=e.getLevel())return void console.log("Already top element, can't tab up");var t=e.getParent(),n=t.getParent(),o=e.getLastDirectChild(),s=t.getChildren();return e.adjustLevel(-1,!0),pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee9(){var a,d,r,l,p;return regeneratorRuntime.wrap(function _callee9$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,taskEntryNeedIds([e,n,t,o]);case 2:return a=i.sent,d=a[0],r=a[3],i.next=7,y.move(a[0],a[1],a[2]);case 7:if(l=s.findIndex(function(t){return t==e}),s.splice(0,l+1),!(1<=s.length)){i.next=15;break}return i.next=12,taskEntryNeedIds(s);case 12:return p=i.sent,i.next=15,y.move(p,d,r);case 15:case"end":return i.stop();}},_callee9)})))}}function taskEntryTabFocused(){var e=k.getFocusedEntry();e&&taskEntryTab(e)}function taskEntryShiftTabFocused(){var e=k.getFocusedEntry();e&&taskEntryShiftTab(e)}function taskMoveEntryUp(e){if(y&&y.move){var t=e.getPrev();if(t){var n=e.getCaret(),o=t.getLevel(),s=t.getPrev(),a=t.getPreviousSibling();e.move(s,o),e.setCaret(n);var i=t.getParent();return pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee10(){var t;return regeneratorRuntime.wrap(function _callee10$(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,taskEntryNeedIds([e,i,a]);case 2:return t=n.sent,n.next=5,y.move(t[0],t[1],t[2]);case 5:case"end":return n.stop();}},_callee10)})))}}}function taskMoveEntryUpFocused(){var e=k.getFocusedEntry();e&&taskMoveEntryUp(e)}function taskMoveEntryDown(e){if(y&&y.move){var t=e.getNextSibling();if(t){var n=e.getCaret(),o=null,s=t.getLevel(),a=null;return 0<t.getAllChildren().length?(o=t,s+=1,a=null):(o=t.getParent(),a=t),e.move(t,s),e.setCaret(n),pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee11(){var t;return regeneratorRuntime.wrap(function _callee11$(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,taskEntryNeedIds([e,o,a]);case 2:return t=n.sent,n.next=5,y.move(t[0],t[1],t[2]);case 5:case"end":return n.stop();}},_callee11)})))}}}function taskMoveEntryDownFocused(){var e=k.getFocusedEntry();e&&taskMoveEntryDown(e)}function taskMerge(e,t){if(y&&y.update&&y.move&&y["delete"]&&e&&t){var n=e.getTitle().length,o=null,s=null;if(t.getParent()==e)o=t.getPrev(),s=t.getPreviousSibling();else{var a=e.getAllChildren();o=0<a.length?a[a.length-1]:e,s=e.getLastDirectChild()}return pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee12(){var a,i,d,r,l,p,c,u,g;return regeneratorRuntime.wrap(function _callee12$(h){for(;;)switch(h.prev=h.next){case 0:return h.next=2,taskEntryNeedIds([e,t,s]);case 2:return a=h.sent,i=a[0],d=a[1],r=a.splice(2,1)[0],h.next=8,y.get(a);case 8:return l=h.sent,p=l[i],c=l[d],u=t.getAllChildren(),o.insertEntriesAfter(u,e.getLevel()-t.getLevel()),g={id:i,title:taskEntryNormalizeTitle(e.getTitle()+t.getTitle()),notes:[p.notes,c.notes].filter(Boolean).join("\r\n")},k["delete"](t),e.patch(g),e.setCaret(n),h.next=19,y.patch(g);case 19:return h.next=21,y.moveChildren(d,i,r);case 21:return h.next=23,y.deleteWithChildren(d);case 23:return h.abrupt("return",h.sent);case 24:case"end":return h.stop();}},_callee12)})))}}function taskMergeForward(e){var t=e.getNext();return t?taskMerge(e,t):void 0}function taskMergeBackward(e){var t=e.getPrev();return t?taskMerge(t,e):void 0}function taskNewInCurrentList(e,t,n){if(y&&y.insert){n||(n=k.last());var o=t?t.getLevel()+1:0,s=k.createEntry(e,o);k.insertEntryAfter(s,n);var a=pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee13(){var o;return regeneratorRuntime.wrap(function _callee13$(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,taskEntryNeedIds([t,n]);case 2:return o=s.sent,e.parent=o[0],s.next=6,y.insert(e,o[1],y.selectedTaskList);case 6:return s.abrupt("return",s.sent);case 7:case"end":return s.stop();}},_callee13)})));return s.promiseId(a),s}}function taskNewSplit(e,t){if(!y||!y.update)return Promise.reject("Not implemented");var n=e.getChildren();if(n&&0<n.length&&!y.move)return Promise.reject("Not implemented");taskEntryTitleCommitNow();var o=e.getTitle();null===t&&(t=o.length);var s=e.getParent(),a={title:o.substring(t)},i={title:o.substring(0,t)},d=taskNewInCurrentList(a,s,e);return d.setCaret(0),i.title!=o&&e.patch(i),pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee14(){var t,n,s;return regeneratorRuntime.wrap(function _callee14$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,taskEntryNeedIds([d,e]);case 2:if(t=a.sent,n=t[0],s=t[1],i.id=t[1],i.title==o){a.next=10;break}return y.cache.patch(i),a.next=10,y.patch(i);case 10:return a.next=12,y.moveChildren(s,n,null);case 12:return a.abrupt("return",a.sent);case 13:case"end":return a.stop();}},_callee14)})))}function taskLiberateChildren(e){var t=e.getChildren();if(!t||0>=t.length)return Promise.resolve();if(!y||!y.move)return Promise.reject("Not implemented");var n=e.getParent(),o=t.splice(0,1)[0];return o.adjustLevel(-1,!1),pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee15(){var s,a,i;return regeneratorRuntime.wrap(function _callee15$(d){for(;;)switch(d.prev=d.next){case 0:return d.next=2,taskEntryNeedIds([e,n,o].concat(t));case 2:return s=d.sent,a=s.splice(3),i=s[2],d.next=7,y.move(i,s[1],s[0]);case 7:return d.next=9,y.move(a,i,null);case 9:return d.abrupt("return",d.sent);case 10:case"end":return d.stop();}},_callee15)})))}function taskDelete(e,t){if(!y||!y["delete"])return Promise.reject("Not implemented");taskEntryTitleCommitNow(),t?e.getAllChildren().forEach(function(e){return k["delete"](e)}):taskLiberateChildren(e);var n=e.getNextSibling()||e.getPreviousSibling()||e.getParent(),o=e.whenHaveId();return k["delete"](e),n&&n.setCaret(),pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee16(){var e;return regeneratorRuntime.wrap(function _callee16$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,o;case 2:return e=t.sent,t.next=5,y.deleteWithChildren(e);case 5:case"end":return t.stop();}},_callee16)})))}function taskPatch(e){return k.patchEntry(e),pushJob(function(){return y.patch(e)})}function taskMoveToList(e,t){console.log("taskMoveToList",e,t);var n=null;t.account&&(n=t.account,t=t.tasklist);var o=e.whenHaveId();return e.getAllChildren().forEach(function(e){return k["delete"](e)}),k["delete"](e),pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee17(){var e;return regeneratorRuntime.wrap(function _callee17$(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,o;case 2:return e=s.sent,console.debug("taskPatchMoveToList: moving",e,"to newList=",t,", newBackend=",n),console.debug("current backend:",y),s.next=7,y.moveToList(e,t,n);case 7:return s.abrupt("return",s.sent);case 8:case"end":return s.stop();}},_callee17)})))}function taskPatchMoveToList(e,t){return console.log("taskPatchMoveToList",e,t),taskPatch(e).then(function(){return taskMoveToList(k.find(e.id),t)})}function tasklistAdd(e){if(e||(e=y),console.log(e),e&&e.tasklistAdd){var t=prompt("Enter a name for the new task list in '"+e.uiName()+"':","");return t?pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee18(){var n;return regeneratorRuntime.wrap(function _callee18$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,e.tasklistAdd(t);case 2:return n=o.sent.id,o.next=5,c.reloadTasklists(e);case 5:setSelectedTaskList(new TaskListHandle(e,n));case 6:case"end":return o.stop();}},_callee18)}))):void 0}}function tasklistRename(e){if(e||(e=selectedTaskList()),e&&e.tasklist){var t=c.find(e.account);if(t&&t.tasklistUpdate){var n=t.ui.tasklists.find(function(t){return t.id==e.tasklist});if(n){var o=n.title,s=prompt("Enter new name for this task list:",o);if(s&&s!=o){var a={id:e.tasklist,title:s};return pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee19(){return regeneratorRuntime.wrap(function _callee19$(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.tasklistPatch(a);case 2:return e.next=4,c.reloadTasklists(t);case 4:case"end":return e.stop();}},_callee19)})))}}}}}function tasklistDelete(e){if(e||(e=selectedTaskList()),e&&e.tasklist){var t=c.find(e.account);if(t&&t.tasklistDelete){if(t!=y)return void window.alert("Cannot delete list which is not opened, atm");if(null!=k.first())return void window.alert("This task list is not empty. Please delete all tasks before deleting the task list.");var n=t.ui.tasklists.find(function(t){return t.id==e.tasklist});if(n){var o=n.title;return confirm("Are you SURE you want to delete task list \""+o+"\"?")?pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee20(){return regeneratorRuntime.wrap(function _callee20$(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.tasklistDelete(e.tasklist);case 2:c.reloadTasklists(t);case 3:case"end":return n.stop();}},_callee20)}))):void 0}}}}function Editor(){this.page=document.getElementById("editorPage"),this.taskListBox=new TaskListBox(document.getElementById("editorTaskList")),this.taskListBox.selectAccounts=!1,this.taskListBox.selectFailedAcconts=!1,this.saveBtn=document.getElementById("editorSave"),this.saveCopyBtn=document.getElementById("editorSaveCopy"),this.saveContinueBtn=document.getElementById("editorSaveContinue"),this.cancelBtn=document.getElementById("editorCancel"),this.deleteBtn=document.getElementById("editorDelete"),this.taskId=null,this.listPageBackup={},document.getElementById("editorTaskTitleBox").onchange=this.setDirty.bind(this,!0),document.getElementById("editorTaskDateP").onchange=this.setDirty.bind(this,!0),document.getElementById("editorTaskNotes").oninput=this.setDirty.bind(this,!0),document.getElementById("editorTaskNotes").onpaste=this.setDirty.bind(this,!0),this.taskListBox.box.onchange=this.taskListChanged.bind(this),this.saveBtn.onclick=this.saveClose.bind(this),this.saveCopyBtn.onclick=this.saveCopyClose.bind(this),this.saveContinueBtn.onclick=this.saveContinue.bind(this),this.cancelBtn.onclick=this.cancel.bind(this),this.deleteBtn.onclick=this.deleteBtnClick.bind(this)}"undefined"!=typeof e&&(e("./utils.js").importSelf(),importAll(e("./backend.js")),importAll(e("./backendDav.js")),importAll(e("./backendGt.js")),importAll(e("./backendLocal.js")),importAll(e("./backendTests.js")),importAll(e("./tasklist.js")));var o=new Unit("undefined"!=typeof n&&n),s=document.getElementById("listPage"),a=null,i=null,d={showAccountsInCombo:{type:"bool",default:!0,title:"Group lists by accounts",hint:"Group tasklists by accounts instead of showing them as a single list"},accountsClickable:{type:"bool",title:"Make accounts clickable",hint:"Make account entries in tasklist combobox clickable -- shows a page with a few account actions when you click on them"},mergeByDelete:{type:"bool",default:!0,title:"Merge by Delete",hint:"Merge the next task into the selected by pressing Delete"},mergeByBackspace:{type:"bool",default:!0,title:"Merge by Backspace",hint:"Merge the selected task into the previous one by pressing Backspace"},singleClickAdd:{type:"bool",title:"Single-click add",hint:"Add new task with a single click on the empty space - as it had been in GTasks. Double click always works"},showDeleted:{type:"bool",default:!1,title:"Show deleted tasks",hint:"Some backends keep track of deleted tasks for a while. Enable this temporarily and restore deleted taks by simply editing and saving them."},urlTrack:{type:"bool",default:!0,title:"URL selection permanence",hint:"Reflect the selected task list in the URL - you can copy the URL and it'll open on the same tasklist/account. The URLs are uglier though"},debug:{type:"bool",title:"Debug",hint:"Enables debug backends and more logging"},uiExtraCss:{type:"text",title:"Extra CSS",hint:"Paths to additional CSS files to customize appearance (can be relative or URLs). Comma-separated.<br />Try: style-canvas.css"},uiMaxWidth:{type:"number",default:0,title:"UI max width",hint:"Limit the UI to this width. Set to 0 to expand to all available horizontal space"}};optionsSetDefaults(d);var r=!1,l=new JobQueue;l.onChanged.subscribe(function(){document.getElementById("activityIndicator").classList.toggle("working",0<l.count)}),l.onError.subscribe(function handleError(e){e.result?e.result.error?printError("Error: "+e.result.error.message):printError(e.result):printError(e)});var p={tasklists:!1,tasks:[]};AddCustomEventTarget(Accounts),Accounts.prototype[Symbol.iterator]=function(){return this.list[Symbol.iterator]()},Accounts.prototype._loadAccountData=function(e){return getLocalStorageItem("tasksIg_account_"+e)||{}},Accounts.prototype._saveAccountData=function(e,t){setLocalStorageItem("tasksIg_account_"+e,t)},Accounts.prototype.load=function(){var e=this;console.log("accountsLoad"),this.list=[];var t=getLocalStorageItem("tasksIg_accounts")||[];console.debug("accountsLoad: list=",t);var n=function _loop(n){if(!t[n])return"continue";var o=e._loadAccountData(t[n]),s=null,a="Cannot create backend: "+o.backendName;try{s=backendCreate(o.backendName)}catch(e){a=e}s||(s=backendCreateDummy(o.backendName,a)),s.id=t[n],o.customName&&(s.customName=o.customName),e.list.push(s),s.init().then(function(){return s.signin(o.params)})["catch"](function(t){s.error=t,e.signinStatusChanged(s,!1)})};for(var o in t){var s=n(o)}this.reloadAllTasklists(),this.changed()},Accounts.prototype.add=function(e,t){if(console.log("Accounts.add",arguments),!e||!e.constructor||!e.constructor.name)return void console.error("accountAdd: invalid account object: ",e);e.id=newGuid();var n={};n.backendName=e.constructor.name,n.params=t,this._saveAccountData(e.id,n);var o=getLocalStorageItem("tasksIg_accounts")||[];o.push(e.id),setLocalStorageItem("tasksIg_accounts",o),this.list.push(e),Array.isArray(e.ui.tasklists)||this.reloadTasklists(e),this.changed()},Accounts.prototype["delete"]=function(e){console.log("Accounts.delete:",e),window.localStorage.removeItem("tasksIg_account_"+e);var t=getLocalStorageItem("tasksIg_accounts")||[],n=t.findIndex(function(t){return t==e});t.splice(n,1),setLocalStorageItem("tasksIg_accounts",t),n=this.findIndex(e),0<=n&&(this.list.splice(n,1),this.changed())},Accounts.prototype.findIndex=function(e){var t=Number.isInteger;return t(e)?e:this.list.findIndex(function(t){return t==e||t.id==e})},Accounts.prototype.find=function(e){var t=this.findIndex(e);return 0<=t&&t<this.list.length?this.list[t]:null},Accounts.prototype.rename=function(e,t){if(console.debug("Accounts.rename",e,t),e=this.find(e),!e)return void console.warn("Account not found: "+(e+""));e.customName=t;var n=this._loadAccountData(e.id);t?n.customName=t:delete n.customName,this._saveAccountData(e.id,n),this.stateChanged(e)},Accounts.prototype.move=function(e,t){if(console.debug("Accounts.move",e,t),e=this.findIndex(e),0>e)return void console.warn("Account not found: "+e);if(!t)t=this.list.length;else if(t=this.findIndex(t),0>t)return void console.warn("Account not found: "+t);if(t!=e){t>e&&t--;for(var n=getLocalStorageItem("tasksIg_accounts")||[],o=n[e],s=this.list[e];e<t;)n[e]=n[e+1],this.list[e]=this.list[e+1],e++;for(;e>t;)n[e]=n[e-1],this.list[e]=this.list[e-1],e--;n[e]=o,this.list[e]=s,setLocalStorageItem("tasksIg_accounts",n),this.changed()}},Accounts.prototype.swap=function(e,t){return e>t?this.move(e,t):this.move(t,e)},Accounts.prototype.changed=function(){console.debug("accountsListChanged; accounts=",this.list),this.dispatchEvent("change")},Accounts.prototype.stateChanged=function(e){console.debug("account.stateChanged:",e),this.dispatchEvent("stateChange",{account:e})},Accounts.prototype.signinStatusChanged=function(e,t){console.debug("account.signinStatusChanged:",t,e),this.reloadTasklists(e),this.stateChanged(e)},Accounts.prototype.reloadAllTasklists=function(){console.debug("reloadAllTasklists");var e=_createForOfIteratorHelper(this),t;try{for(e.s();!(t=e.n()).done;){var n=t.value;this.reloadTasklists(n)}}catch(t){e.e(t)}finally{e.f()}},Accounts.prototype.reloadTasklists=function(e){console.debug("account.reloadTasklists:",e);var t=null;return e.isSignedIn()?t=e.tasklistList():(console.debug("Not initialized/not signed in, no lists"),t=Promise.resolve(null)),t.then(function(t){!e.ui.tasklits&&!t||Array.isArray(e.ui.tasklists)&&isEmpty(e.ui.tasklists)&&Array.isArray(t)&&isEmpty(t)||(e.ui.tasklists=t,console.debug("account.reloadTasklists: new lists available for account",e),accountStateChanged(e))}),t};var c=new Accounts;c.addEventListener("change",accountListChanged),c.addEventListener("stateChange",function(e){return accountStateChanged(e.account)}),inherit(CustomPage,AccountsPage),AccountsPage["new"]=function(){return new AccountsPage},AccountsPage.prototype.close=function(){console.debug("AccountsPage.close"),this.page.classList.toggle("hidden",!0)},AccountsPage.prototype.reload=function(){this.content.reload(),this.updateAccountActions()},AccountsPage.prototype.selectedIndex=function(){return this.content.selected?c.findIndex(this.content.selected.account):void 0},AccountsPage.prototype.updateAccountActions=function(){var e=this.content.selected,t=e?c.findIndex(e.account):void 0;console.debug("AccountsPage.updateAccountActions",e),document.getElementById("accountListEditSettings").disabled=!e,document.getElementById("accountListDelete").disabled=!e,document.getElementById("accountListReset").disabled=!e||!options.debug||!c.list[t].reset,document.getElementById("accountListMoveUp").disabled=!e||0>=t,document.getElementById("accountListMoveDown").disabled=!e||t>=c.length-1},AccountsPage.prototype.moveUpClick=function(){var e=this.selectedIndex();0>=e||e>c.length-1||(c.swap(e,e-1),this.reload())},AccountsPage.prototype.moveDownClick=function(){var e=this.selectedIndex();0>e||e>=c.length-1||(c.swap(e+1,e),this.reload())},AccountsPage.prototype.addClick=function(){var e=this;StartNewAccountUi({hasCancel:!0}).then(function(){return e.reload()})},AccountsPage.prototype.renameClick=function(){var e=this,t=c.find(this.content.selected.account);t&&accountRename(t).then(function(){return e.reload()})},AccountsPage.prototype.editSettingsClick=function(){var e=this,t=c.find(this.content.selected.account);t&&accountEditSettings(t).then(function(){return e.reload()})},AccountsPage.prototype.deleteClick=function(){var e=this,t=c.find(this.content.selected.account);t&&accountDelete(t).then(function(t){t&&(e.reload(),0==e.content.options.length&&(console.log("AccountsPage: no accounts left, cancelling the page"),e.reject(new FormCancelError)))})},AccountsPage.prototype.resetClick=function(){var e=this.content.selected.account;e&&accountReset(e)},inherit(CustomPage,BackendSelectPage),BackendSelectPage.prototype.reload=function(){var e=this;if(this.content.textContent=0<backends.length?this.prompt:"No backends available, see error log for details",nodeRemoveChildrenByTagName(this.content,"button"),backends.forEach(function(t){var n=document.createElement("button");n.textContent=t.uiName||t.name,n.associatedBackend=t,n.onclick=e.backendClicked.bind(e,n),e.content.appendChild(n)}),this.hasCancel){var t=document.createElement("p");t.classList.toggle("backend-separator",!0),this.content.appendChild(t);var n=document.createElement("button");n.textContent="Cancel",n.onclick=this.cancelClick.bind(this),this.content.appendChild(n)}},BackendSelectPage.prototype.close=function(){this.page.classList.toggle("hidden",!0)},BackendSelectPage.prototype.backendClicked=function(e){var t=this,n=e.associatedBackend;console.log("Setting up backend",n),this.disable();var o=backendCreate(n);o.init().then(function(){if(console.debug("Backend initialized"),!o.settingsPage)return o.setup({});var e=o.settingsPage();if(!e)return o.setup({});var t=new BackendSettingsPage(o.uiName(),e);return t.addEventListener("ok",function(e){return t.disable(),o.setup(e.results).then(function(e){t.resolve(e)})["catch"](function(e){console.log("Backend.setup() error:",e),window.alert(e),t.reenable()})}),t.waitResult()}).then(function(e){c.add(o,e),t.okClick(o)})["catch"](function(e){return console.log("Could not configure backend:",e),e instanceof FormCancelError||window.alert(e),t.reenable(),null})},BackendSelectPage.prototype.disable=function(){for(var e=0;e<this.page.children.length;e++)this.page.children[e].disabled=!0},BackendSelectPage.prototype.reenable=function(){for(var e=0;e<this.page.children.length;e++)this.page.children[e].disabled=!1},inherit(CustomPage,SettingsPage),SettingsPage.prototype.disable=function(){this.btnOk.disabled=!0},SettingsPage.prototype.reenable=function(){this.btnOk.disabled=!1},SettingsPage.prototype.close=function(){this.reload({}),this.page.classList.toggle("hidden",!0)},SettingsPage.prototype.reload=function(e){for(var t in nodeRemoveAllChildren(this.content),e){var n=e[t],o=document.createElement("div");o.classList.toggle("settingsRow",!0),this.content.appendChild(o);var s=document.createElement("label");s.id="settingsLabel-"+t,s.textContent="title"in n?n.title:t[0].toUpperCase()+t.slice(1),s.htmlFor="settingsValue-"+t;var a=null;if(["text","number","password","date","time","url","email"].includes(n.type))a=document.createElement("input"),a.type=n.type;else if("datetime"==n.type)a=document.createElement("input"),a.type="datetime-local";else if("bool"==n.type)a=document.createElement("input"),a.type="checkbox";else if(Array.isArray(n.type)){a=document.createElement("select");for(var d=0,r;d<n.type.length;d++)r=document.createElement("option"),r.value=n.type[d],r.textContent=n.type[d],a.append(r)}if(a&&(a.id="settingsValue-"+t,a.dataId=t,"default"in n&&("bool"==n.type?a.checked=n["default"]:a.value=n["default"])),"bool"==n.type?(o.appendChild(a),o.appendChild(s)):(o.appendChild(s),a&&o.appendChild(a)),"hint"in n){var l=document.createElement("p");l.innerHTML=n.hint,l.classList+="settingsHintText",o.append(l)}}},SettingsPage.prototype.setValues=function(e){for(var t=this.content.getElementsByTagName("input"),n=0;n<t.length;n++)if(t[n].dataId){var o=e[t[n].dataId];"undefined"==typeof o||(console.log("setting",t[n].dataId,"to",o),"checkbox"==t[n].type?t[n].checked=o:t[n].value=o)}t=this.content.getElementsByTagName("input");for(var s=0;s<t.length;s++)if(t[s].dataId){var a=e[t[s].dataId];"undefined"==typeof a||(console.log("setting",t[s].dataId,"to",a),t[s].value=a)}},SettingsPage.prototype.collectResults=function(){for(var e={},t=this.content.getElementsByTagName("input"),n=0,o;n<t.length;n++)o=null,o="checkbox"==t[n].type?t[n].checked:t[n].value,e[t[n].dataId]=o;t=this.content.getElementsByTagName("select");for(var s=0;s<t.length;s++)e[t[s].dataId]=t[s].value;return e},inherit(SettingsPage,BackendSettingsPage),TaskListHandle.prototype.toString=function(){var e=this.account;return!e||"string"==typeof e||(e=e.id),JSON.stringify({account:e,tasklist:this.tasklist})},TaskListHandle.fromString=function(e){return e?(e=JSON.parse(e),e.account&&(e.account=c.find(e.account)),new TaskListHandle(e.account,e.tasklist)):null},TaskListBox.prototype.reload=function(){console.debug("tasklistBoxReload");var e=this.box.value;nodeRemoveAllChildren(this.box);var t=_createForOfIteratorHelper(c),n;try{for(t.s();!(n=t.n()).done;){var o=n.value;console.debug("tasklistBoxReload: account=",o,"signedIn=",o.isSignedIn(),"ui=",o.ui);var s=document.createElement("option");if(s.text=o.uiName(),s.classList.toggle("optionAccount",!0),s.value=new TaskListHandle(o.id,void 0)+"",this.selectAccounts||(s.disabled=!0),!o.isSignedIn()||!o.ui||!o.ui.tasklists||isArrayEmpty(o.ui.tasklists)){this.selectFailedAccounts&&(s.disabled=!1),o.error?s.text+=" (error)":o.isSignedIn()?!!o.ui&&!!o.ui.tasklists&&isArrayEmpty(o.ui.tasklists)&&(s.text+=" (no lists)"):s.text+=" (signing in)",s.classList.toggle("grayed",!0),this.box.add(s);continue}else this.showAccounts&&this.box.add(s);for(var a in o.ui.tasklists){var i=o.ui.tasklists[a],d=document.createElement("option");d.value=new TaskListHandle(o.id,i.id)+"",d.text=i.title,this.showAccounts&&d.classList.toggle("offset",!0),this.box.add(d)}}}catch(e){t.e(e)}finally{t.f()}if(0>=c.length){var r=document.createElement("option");r.hidden=!0,r.text="No accounts",r.value="",this.box.add(r),this.box.classList.toggle("grayed",!0)}else this.box.classList.toggle("grayed",!1);this.box.value=e},TaskListBox.prototype.selected=function(){var e=this.box.value;return e&&(e=TaskListHandle.fromString(e)),e},TaskListBox.prototype.selectedTitle=function(){return this.box.options[this.box.selectedIndex].text},TaskListBox.prototype.setSelected=function(e,t){console.debug("setSelectedTaskList:",arguments),e=e+"";this.box.value==e||(this.box.value=e,!t&&this.changed())},TaskListBox.prototype.changed=function(){this.box.dispatchEvent(new Event("change"))},inherit(TaskListBox,MainTaskListBox),MainTaskListBox.prototype.reload=function(){var e=this.box.value;TaskListBox.prototype.reload.call(this);var t=e,n=urlReadState();if(n&&(t=n),this.box.value=t+"",0<=this.box.selectedIndex&&!this.box.options[this.box.selectedIndex].disabled)return void(e+""!=t+""&&this.changedSkipUrl());console.debug("tasklistBox.reload: Selection",t+"","is lost, selecting a substitute"),"string"==typeof t&&(t=TaskListHandle.fromString(t));for(var o=-1,s=-1,a=0,d;a<this.box.options.length;a++)if(d=this.box.options[a],!d.disabled&&d.value){if(0>s&&(s=a),!t||!t.account)break;var r=TaskListHandle.fromString(d.value);if(!!r&&r.account==t.account){o=a;break}}console.debug("newIndex:",o,"firstNonDisabledIndex:",s,"base sel:",t),0>o&&(o=s),this.box.selectedIndex=o;var l=this.selected();return e+""==l+""?void 0:l&&l.account?l.tasklist?void this.changed():l.account.ui&&l.account.ui.tasklists&&!l.account.error?void this.changed():void this.changedSkipUrl():void this.changedSkipUrl()},MainTaskListBox.prototype.changedSkipUrl=function(){this.skipUrl=!0,this.changed()},MainTaskListBox.prototype._handleChanged=function(){return this.skipUrl?void(this.skipUrl=!1):void(options.urlTrack?urlSaveState(this.selected()):urlSaveState(null))};var u=new MainTaskListBox(document.getElementById("listSelectBox"));AddCustomEventTarget(TaskListPanel),TaskListPanel.prototype.reload=function(){console.debug("tasklistPanelReload"),nodeRemoveAllChildren(this.box);var e=_createForOfIteratorHelper(c),t;try{for(e.s();!(t=e.n()).done;){var n=t.value,o=this.addItem(n.uiName());o.classList.add("account"),o.listHandle=new TaskListHandle(n.id,void 0),o.body.addEventListener("click",this.itemClicked.bind(this,o));var s=Dropdown.init();if(s.button.title="Account actions",this.selectAccounts&&(s.add("Open","accountSelectBtn").onclick=setSelectedTaskList.bind(null,o.listHandle,!1)),n.tasklistAdd&&(s.add("Add list","tasklistAddBtn").onclick=tasklistAdd.bind(null,n)),s.addSeparator(),s.add("Rename...","accountRenameBtn").onclick=accountRename.bind(null,n),s.add("Settings...","accountEditBtn").onclick=accountEditSettings.bind(null,n),s.add("Delete","accountDeleteBtn").onclick=accountDelete.bind(null,n),options.debug&&n.reset&&(s.add("Reset","accountResetBtn").onclick=accountReset.bind(null,n)),o.appendChild(s),this.selectAccounts||o.classList.add("disabled"),this.dragMgr.addElement(o),this.showAccounts||(o.style.display="none"),!n.isSignedIn()||!n.ui||!n.ui.tasklists){this.selectFailedAccounts&&o.classList.remove("disabled"),n.error?o.classList.add("error"):n.isSignedIn()?!!n.ui&&!!n.ui.tasklists&&isArrayEmpty(n.ui.tasklists)&&o.classList.add("empty"):o.classList.add("loading"),o.classList.add("grayed");continue}else if(isArrayEmpty(n.ui.tasklists));if(this.showLists){for(var a in n.ui.tasklists){var i=n.ui.tasklists[a],d=this.addItem(i.title);d.listHandle=new TaskListHandle(n.id,i.id),d.classList.add("tasklist"),d.body.addEventListener("click",this.itemClicked.bind(this,d));var r=Dropdown.init();r.button.title="List actions",r.add("Open list","listSelectBtn").onclick=setSelectedTaskList.bind(null,d.listHandle,!1),n.tasklistUpdate&&(r.add("Rename list...","listRenameBtn").onclick=tasklistRename.bind(null,d.listHandle)),n.tasklistDelete&&(r.add("Delete list","listDeleteBtn").onclick=tasklistDelete.bind(null,d.listHandle)),d.appendChild(r)}if(n.tasklistAdd){var l=this.addItem("\uFF0B");l.listHandle=new TaskListHandle(n.id,null),l.classList.add("tasklistAdd"),l.body.addEventListener("click",tasklistAdd.bind(null,n))}}}}catch(t){e.e(t)}finally{e.f()}if(0>=c.length){var p=this.addItem("No accounts");p.classList.add("account"),p.classList.add("grayed"),p.listHandle=null}var u=this.addItem("Add account");u.classList.add("accountAdd"),u.addEventListener("click",StartNewAccountUi.bind(null,{hasCancel:!0})),this.applySelected(this.selected)},TaskListPanel.prototype.addItem=function(e){var t=document.createElement("li");return t.grip=document.createElement("div"),t.grip.classList.add("dragGrip"),t.appendChild(t.grip),t.body=document.createElement("span"),e&&(t.body.textContent=e),t.appendChild(t.body),this.box.appendChild(t),t},TaskListPanel.prototype.itemClicked=function(e){if(!e.classList.contains("disabled")){var t=e.listHandle;t&&this.setSelected(t)}},TaskListPanel.prototype.setSelected=function(e){console.debug("TaskListPanel.setSelected",arguments);this.selected+""==e+""||(this.selected=e,this.dispatchEvent("change",{selected:e}),this.applySelected(this.selected))},TaskListPanel.prototype.applySelected=function(e){for(var t=this.box.children,n=0;n<t.length;n++)t[n].classList.toggle("selected",!!e&&t[n].listHandle+""==e+"")},TaskListPanel.prototype.findParentAccount=function(e){for(!e.nodeType==Node.ELEMENT_NODE&&(e=e.previousElementSibling);!!e&&!e.classList.contains("account");){if(!e.classList.contains("tasklist")&&!e.classList.contains("taskListAdd"))return null;e=e.previousElementSibling}return e},TaskListPanel.prototype.findPreviousAccount=function(e){for(;!!e&&!e.classList.contains("account");)e=e.previousElementSibling;return e},TaskListPanel.prototype.findNextAccount=function(e){for(;!!e&&!e.classList.contains("account");)e=e.nextElementSibling;return e},TaskListPanel.prototype.getAccountChildren=function(e){for(var t=[],n=e.nextSibling;n&&(n.nodeType!=Node.ELEMENT_NODE||n.classList.contains("tasklist")||n.classList.contains("tasklistAdd"));)t.push(n),n=n.nextSibling;return t},inherit(ItemDragMgr,TaskListPanelDragMgr),TaskListPanelDragMgr.prototype.dragStart=function(e){return!!e.classList.contains("account")&&ItemDragMgr.prototype.dragStart.call(this,e)},TaskListPanelDragMgr.prototype.dragCommit=function(){var e=this.dragNode;if(this.context.oldPrev!=e.previousElementSibling&&e.classList.contains("account")){var t=e.listHandle.account,n=this.parent.findNextAccount(e.nextSibling),o=n?n.listHandle.account:null;c.move(t,o)}},TaskListPanelDragMgr.prototype.getNodeChildren=function(e){return this.parent.getAccountChildren(e)},TaskListPanelDragMgr.prototype.getInsertPoints=function(e){var t=this.parent.findPreviousAccount(e),n=this.parent.findNextAccount(e.nextSibling),o=t;if(t){var s=this.parent.getAccountChildren(t);0<s.length&&(o=s[s.length-1])}var a=[];return t&&a.push(t),o&&a.push(o.nextElementSibling),n&&a.push(n),a},inherit(TaskListPanel,MainTaskListPanel),MainTaskListPanel.prototype.itemClicked=function(e){if(!e.classList.contains("disabled")){var t=e.listHandle;t&&setSelectedTaskList(t)}};var g=new MainTaskListPanel(document.querySelector("#listPage .tasklistPanel"));Splitter.ID_BASE="tasksIg_";var h=new Splitter(document.getElementById("listPageSplitter")),y=null,k=null,m=null,f=null,b=null;Editor.prototype.open=function(e){var t=this;if(e)return console.log("Opening editor for task "+e),pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee21(){var n;return regeneratorRuntime.wrap(function _callee21$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,y.get(e);case 2:if(n=o.sent,n){o.next=7;break}return console.log("Failed to load the requested task for editing"),t.taskId=null,o.abrupt("return");case 7:t.taskListBox.reload(),document.getElementById("editorTaskTitle").innerText=n.title,document.getElementById("editorTaskTitleBox").checked="completed"==n.status,document.getElementById("editorTaskTitleP").classList.toggle("completed","completed"==n.status),document.getElementById("editorTaskDate").valueAsDate=n.due?new Date(n.due):null,document.getElementById("editorTaskNotes").value=n.notes?n.notes:"",t.taskListBox.setSelected(selectedTaskList()),t.taskId=e,t.taskListChanged(),t.setDirty(!1),t.beforeUnloadWrapper=t.beforeUnloadWrapper||function(e){return t.beforeUnload(e)},window.addEventListener("beforeunload",t.beforeUnloadWrapper),t.listPageBackup.display=s.style.display,s.style.display="none",t.page.classList.remove("hidden");case 22:case"end":return o.stop();}},_callee21)})))},Editor.prototype.cancel=function(){console.log("Closing the editor"),this.page.classList.toggle("hidden",!0),s.style.display=this.listPageBackup.display,this.taskId=null,window.removeEventListener("beforeunload",this.beforeUnloadWrapper)},Editor.prototype.setDirty=function(e){this._dirty=e,this.contentChanged()},Editor.prototype.beforeUnload=function(e){var t="";return this._dirty&&(t="You have unsaved changes in the Task editor. If you close the page they may be lost"),t&&(e.preventDefault(),e.returnValue=t),t},Editor.prototype.taskListChanged=function(){if(this.taskId){var e=selectedTaskList(),t=this.taskListBox.selected(),n=!1,o=!1,s=e.account&&e.account["delete"],a=!1;t+""==e+""?(n=!1,a=t.account&&t.account.update,o=a):(n=t.account&&t.account.insert,a=t.account&&t.account.insert,o=a&&s),this.deleteBtn.disabled=!s,this.saveCopyBtn.disabled=!n,this.saveBtn.disabled=!o,this.saveContinueBtn.classList.toggle("hidden",t+""!=e+""),this.saveCopyBtn.classList.toggle("hidden",t+""==e+""),document.getElementById("editorMoveNotice").classList.toggle("hidden",t+""==e+""||!o&&!n),document.getElementById("editorMoveBackendNotice").classList.toggle("hidden",t.account==e.account||!o&&!n),document.getElementById("editorCannotEditNotice").classList.toggle("hidden",a),this.setDirty(!0)}},Editor.prototype.contentChanged=function(){this.saveContinueBtn.disabled=!this._dirty||this.saveBtn.disabled},Editor.prototype.getPatch=function(){var e={id:this.taskId};return taskResSetCompleted(e,document.getElementById("editorTaskTitleBox").checked),e.due=document.getElementById("editorTaskDate").valueAsDate,e.notes=document.getElementById("editorTaskNotes").value,e.deleted=!1,e},Editor.prototype.newSaveJob=function(){var e=this.getPatch(),t=null,n=this.taskListBox.selected();return t=n+""==selectedTaskList()+""?taskPatch(e):taskPatchMoveToList(e,n),t},Editor.prototype.saveContinue=function(){this.taskId&&(this.newSaveJob(),this.setDirty(!1))},Editor.prototype.saveClose=function(){var e=this;if(!this.taskId)return void this.cancel();this.newSaveJob().then(function(){e.setDirty(!1),e.cancel()})},Editor.prototype.saveCopyClose=function(){var e=this;if(!this.taskId)return void this.cancel();var t=this.getPatch(),n=this.taskListBox.selected();return n&&n.account&&n.tasklist?pushJob(_asyncToGenerator(regeneratorRuntime.mark(function _callee22(){var o,s;return regeneratorRuntime.wrap(function _callee22$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,y.get(e.taskId);case 2:return o=a.sent,resourcePatch(o,t),s={},s[o.id]={task:o},a.next=8,y.copyToList(s,n.tasklist,n.account,!0);case 8:e.setDirty(!1),e.cancel();case 10:case"end":return a.stop();}},_callee22)}))):void 0},Editor.prototype.deleteBtnClick=function(){var e=this;this.taskId&&taskDelete(k.find(this.taskId)).then(function(){return e.cancel()})};var v=new Editor;(function initUi(){if(window.addEventListener("beforeunload",handleBeforeUnload),console.log("initUi:options:",options),options.uiMaxWidth&&0<options.uiMaxWidth&&(document.body.style.maxWidth=options.uiMaxWidth+"px"),"string"==typeof options.uiExtraCss){var e=_createForOfIteratorHelper(options.uiExtraCss.split(",")),t;try{for(e.s();!(t=e.n()).done;){var n=t.value,o=document.createElement("link");o.rel="stylesheet",o.type="text/css",o.href=n,document.head.appendChild(o)}}catch(t){e.e(t)}finally{e.f()}}var d=document.getElementById("listSelectBox");d.addEventListener("change",selectedTaskListChanged);var r=document.getElementById("listContent");r.addEventListener("click",tasklistClick),r.addEventListener("dblclick",tasklistDblClick);var l=Dropdown.init("mainmenu"),p=Dropdown.init("taskmenu");p.button.classList.toggle("button",!0),a=new Toolbar(document.getElementById("listPanelToolbar")),i=new Toolbar(document.getElementById("listToolbar")),Actions.bind(document.body,"accountsPageOpen",AccountsPage["new"].bind(AccountsPage)),Actions.bind(document.body,"optionsPageOpen",optionsPageOpen),Actions.bind(document.body,"accountsReload",c.reloadAllTasklists.bind(c)),Actions.bind(document.body,"accountAdd",accountAdd.bind(null,null)),Actions.bind(s,"accountReset",accountReset.bind(null,null)),Actions.bind(s,"listAdd",tasklistAdd.bind(null,null)),Actions.bind(s,"listRename",tasklistRename.bind(null,null)),Actions.bind(s,"listDelete",tasklistDelete.bind(null,null)),Actions.bind(s,"tasksClearCompleted",tasklistClearCompleted);var u=Actions.bind(s,"tasksShowCompleted",filterShowCompleted);u.autoCheck=!0,Actions.bind(s,"tasksRefresh",tasklistReloadSelected),Actions.bind(s,"taskAdd",taskEntryAddClicked),Actions.bind(s,"taskEdit",taskEntryEditFocused),Actions.bind(s,"taskTab",taskEntryTabFocused),Actions.bind(s,"taskShiftTab",taskEntryShiftTabFocused),Actions.bind(s,"taskMoveUp",taskMoveEntryUpFocused),Actions.bind(s,"taskMoveDown",taskMoveEntryDownFocused),Actions.bind(s,"taskDelete",taskEntryDeleteFocused),Actions.bind(s,"taskDeleteRecursive",taskEntryDeleteRecursiveFocused),Actions.bind(s,"taskCopyJSON",taskEntryCopyJSON),Actions.bind(s,"taskExportToFile",taskEntryExportToFile),Actions.bind(s,"tasksExportAllToFile",taskEntryExportAllToFile),tasklistInit(),c.load()})()},{"./backend.js":1,"./backendDav.js":2,"./backendGt.js":3,"./backendLocal.js":4,"./backendTests.js":5,"./tasklist.js":7,"./utils.js":8}],7:[function(e,t,n){'use strict';function _createForOfIteratorHelper(e,t){var a;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(a=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){a&&(e=a);var s=0,n=function F(){};return{s:n,n:function n(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var d=!0,r=!1,l;return{s:function s(){a=e[Symbol.iterator]()},n:function n(){var e=a.next();return d=e.done,e},e:function e(t){r=!0,l=t},f:function f(){try{d||null==a["return"]||a["return"]()}finally{if(r)throw l}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}function TaskList(e){this.root=e,this.dragMgr=new TaskEntryDragMgr(this),this.dragMgr.autoShield=!0,this.dragMgr.dragDelay=500,this.setupEventTarget(this.root)}function TaskEntry(e){this.node=document.createElement("div"),this.node.className="task",this.node.taskId=e.id,this.node.taskEntry=this,this.node.addEventListener("click",this.onNodeClicked.bind(this)),this.setupEventTarget(this.node);var t=null;t=document.createElement("div"),t.className="dragGrip",this.node.appendChild(t),this.gripCtl=t,t=document.createElement("input"),t.type="checkbox",t.className="taskCheck",t.display="inline",t.addEventListener("change",this.onChecked.bind(this)),this.node.appendChild(t),this.checkCtl=t;var n=document.createElement("div");n.className="taskWrap",this.node.appendChild(n),t=document.createElement("div"),t.className="taskTitle",t.contentEditable=!0,t.addEventListener("input",this.onTitleInput.bind(this)),t.addEventListener("paste",this.onTitlePaste.bind(this)),n.appendChild(t),this.titleCtl=t,t=document.createElement("p"),t.className="taskNotesShort",t.addEventListener("click",this.onEditClicked.bind(this)),n.appendChild(t),this.notesCtl=t,t=document.createElement("p"),t.className="taskDue",t.addEventListener("click",this.onEditClicked.bind(this)),n.appendChild(t),this.dueCtl=t,t=document.createElement("a"),t.className="taskEditLink",t.appendChild(document.createTextNode(">")),t.addEventListener("click",this.onEditClicked.bind(this)),this.node.appendChild(t),this.setTitle(e.title),this.setNotes(e.notes),this.setDue(e.due),this.setCompleted("completed"==e.status),this.setDeleted(!!e.deleted)}function elementIsTaskEntryNode(e){return e&&Object.prototype.hasOwnProperty.call(e,"taskId")}function elementGetOwnerTaskNode(e){for(;e&&!elementIsTaskEntryNode(e);)e=e.parentNode;return e}function elementGetOwnerTaskEntry(e){return e=elementGetOwnerTaskNode(e),e?e.taskEntry:null}function TaskEntryDragMgr(e){ItemDragMgr.call(this),this.parent=e}"undefined"!=typeof e&&e("./utils.js").importSelf();var o=new Unit("undefined"!=typeof n&&n);o["export"](TaskList),AddCustomEventTarget(TaskList),TaskList.prototype.toString=function(){return"TaskList "+this.root.toString()},TaskList.prototype.clear=function(){this.clearFocus(),nodeRemoveAllChildren(this.root)},TaskList.prototype.appendEntry=function(e){return this.root.appendChild(e.node)},TaskList.prototype.insertEntryBefore=function(e,t){t?this.root.insertBefore(e.node,t.node):this.appendEntry(e)},TaskList.prototype.insertEntryAfter=function(e,t){this.insertEntryBefore(e,t?t.getNext():this.first())},TaskList.prototype.appendTask=function(e,t){this.appendEntry(this.createEntry(e,t))},TaskList.prototype.appendTaskChildren=function(e,t,n){for(var o=[],s=0,a;s<n.length;s++)a=n[s],!e&&a.parent||e&&a.parent!=e||!options.showDeleted&&a.deleted||o.push(a);o=o.sort(function(e,t){return e.position-t.position}),this.appendTasksWithChildren(o,t,n)},TaskList.prototype.appendOrphans=function(e){for(var t={},n=0;n<e.length;n++)t[e[n].id]=e[n];for(var o=[],s=0,a;s<e.length;s++)a=e[s],!a.parent||a.parent in t||!options.showDeleted&&a.deleted||o.push(a);this.appendTasksWithChildren(o,0,e)},TaskList.prototype.appendTasksWithChildren=function(e,t,n){for(var o=0;o<e.length;o++)(this.appendTask(e[o],t),e[o].id&&e[o].id!=e[o].parent)&&this.appendTaskChildren(e[o].id,t+1,n)},TaskList.prototype.createEntry=function(e,t){var n=new TaskEntry(e);return n.setLevel(t),this.dragMgr.addElement(n),n.addEventListener("focusin",this.onEntryFocus.bind(this)),n.addEventListener("focusout",this.onEntryBlur.bind(this)),n.gripCtl.addEventListener("mousedown",this.onEntryDragGripMouseDown.bind(this)),n.gripCtl.addEventListener("touchstart",this.onEntryDragGripMouseDown.bind(this)),n.titleCtl.addEventListener("blur",this.onEntryTitleFocusOut.bind(this),!0),n},TaskList.prototype["delete"]=function(e){this.clearFocus(e),e.node.remove()},o["export"](TaskEntry),TaskEntry.prototype.toString=function(){return this.node.toString()},AddCustomEventTarget(TaskEntry),TaskEntry.prototype.patch=function(e){"title"in e&&this.setTitle(e.title),"notes"in e&&this.setNotes(e.notes),"due"in e&&this.setDue(e.due),"status"in e&&this.setCompleted("completed"==e.status),"deleted"in e&&this.setDeleted(!!e.deleted)},TaskList.prototype.patchEntry=function(e,t){t||(t=this.find(e.id)),t.patch(e)},TaskList.prototype.first=function(){var e=this.root.firstChild;return e?e.taskEntry:null},TaskList.prototype.last=function(){var e=this.root.lastChild;return e?e.taskEntry:null},TaskEntry.prototype.getPrev=function(){var e=this.node.previousElementSibling;return e?e.taskEntry:null},TaskEntry.prototype.getNext=function(){var e=this.node.nextElementSibling;return e?e.taskEntry:null},TaskList.prototype.allEntries=function(){for(var e=[],t=this.first();null!=t;)e.push(t),t=t.getNext();return e},TaskEntry.prototype.getId=function(){return this.node.taskId},TaskEntry.prototype.setId=function(e){this.node.taskId=e},TaskList.prototype.find=function(e){e&&e.id&&(e=e.id);for(var t=this.root.children,n=0;n<t.length;n++)if(t[n].taskId==e)return t[n].taskEntry;return null},TaskEntry.prototype.promiseId=function(e){var t=this,n=e.then(function(e){return t.setId(e.id),e.id});return this.setId(n),n},TaskEntry.prototype.whenHaveId=function(){return Promise.resolve(this.getId())},o["export"](function taskEntryNeedIds(e){var t=[];return e.forEach(function(e){e?t.push(e.whenHaveId()):t.push(Promise.resolve(null))}),Promise.all(t)}),o["export"](elementGetOwnerTaskEntry),TaskEntry.prototype.getLevel=function(){return this.taskNestingLevel?this.taskNestingLevel:0},TaskEntry.prototype.setLevel=function(e){var t=this.taskNestingLevel;t||(t=0),this.node.classList.remove("childlvl-"+t),this.taskNestingLevel=e,this.node.classList.add("childlvl-"+e),this.node.style.paddingLeft=10*e+"px"},TaskEntry.prototype.adjustLevel=function(e,t){var n=t?this.getAllChildren():[];this.setLevel(this.getLevel()+e),n.forEach(function(t){return t.setLevel(t.getLevel()+e)})},TaskEntry.prototype.getParent=function(){var e=this.getLevel();if(0==e)return null;for(var t=this.node.previousElementSibling;t;){if(t.taskEntry.getLevel()<e)return t.taskEntry;t=t.previousElementSibling}return null},TaskEntry.prototype.isChildOf=function(e){for(var t=this;t&&t!=e;)t=t.getParent()},TaskEntry.prototype.getPreviousSibling=function(){for(var e=this.getLevel(),t=this.node.previousElementSibling;t&&t.taskEntry.getLevel()>e;)t=t.previousElementSibling;return!t||t.taskEntry.getLevel()<e?null:t.taskEntry},TaskEntry.prototype.getNextSibling=function(){for(var e=this.getLevel(),t=this.node.nextElementSibling;t&&t.taskEntry.getLevel()>e;)t=t.nextElementSibling;return!t||t.taskEntry.getLevel()<e?null:t.taskEntry},TaskEntry.prototype.getChildren=function(e){e||(e=1);for(var t=[],n=this.getLevel(),o=this.node.nextElementSibling;o&&o.taskEntry.getLevel()>n;)o.taskEntry.getLevel()<=n+e&&t.push(o.taskEntry),o=o.nextElementSibling;return t},TaskEntry.prototype.getAllChildren=function(){return this.getChildren(1e3)},TaskEntry.prototype.getLastDirectChild=function(){var e=this.getChildren();return 0<e.length?e[e.length-1]:null},TaskEntry.prototype.move=function(e,t){var n=this.getAllChildren();e!=this.getPrev()&&(e?e.node.parentNode.insertBefore(this.node,e.node.nextSibling):this.node.parentNode.insertBefore(this.node,this.node.parentNode.firstChild));var o=t-this.getLevel();return this.setLevel(t),this.insertEntriesAfter(n,o)},TaskEntry.prototype.moveChildren=function(e,t){return e.insertChildren(this.getAllChildren(),t)},TaskEntry.prototype.insertEntriesAfter=function(e,t){var n=this,o=this.node.nextSibling;return e.forEach(function(e){n.node.parentNode.insertBefore(e.node,o),e.adjustLevel(t)}),this},TaskEntry.prototype.getControl=function(e){var t=this.node.getElementsByClassName(e)[0];if(!t)throw"Control '"+e+"' not found for taskEntry '"+this.node+"\"";return t},TaskEntry.prototype.getTitle=function(){return Editable.getText(this.titleCtl)},TaskEntry.prototype.setTitle=function(e){Editable.setText(this.titleCtl,e)},o["export"](function taskEntryNormalizeTitle(e){return e.trim()}),TaskEntry.prototype.setNotes=function(e){nodeRemoveAllChildren(this.notesCtl),e&&this.notesCtl.appendChild(document.createTextNode(e.substring(0,200)))},TaskEntry.prototype.setDue=function(e){if(nodeRemoveAllChildren(this.dueCtl),e){var t=new Date(e);this.dueCtl.appendChild(document.createTextNode(t.toDateString()))}},TaskEntry.prototype.getCompleted=function(){return this.checkCtl.checked},TaskEntry.prototype.setCompleted=function(e){this.checkCtl.checked=e,this.node.classList.toggle("completed",e)},TaskEntry.prototype.setDeleted=function(e){this.node.classList.toggle("deleted",e)},TaskEntry.prototype.getLength=function(){var e=Editable.getLength(this.titleCtl);return e},TaskEntry.prototype.getSelection=function(){return Editable.getSelection(this.titleCtl)},TaskEntry.prototype.getCaret=function(){var e=Editable.getCaret(this.titleCtl);return e},TaskEntry.prototype.setCaret=function(e,t){Editable.setCaret(this.titleCtl,e,t)},TaskList.prototype.onEntryFocus=function(e){console.log("entryfocus"),console.log(e),this.focusedTaskEntry&&this.clearFocus(this.focusedTaskEntry,{noNotify:!0}),this.focusedTaskEntry=e.currentTarget.taskEntry,e.currentTarget.classList.add("focused"),this.focusChanged()},TaskList.prototype.onEntryBlur=function(){},TaskList.prototype.clearFocus=function(e,t){e&&this.focusedTaskEntry!=e||(this.focusedTaskEntry=null),e&&e.node.classList.remove("focused"),t&&t.noNotify||this.focusChanged()},TaskList.prototype.focusChanged=function(){var e=new CustomEvent("focuschanged");this.dispatchEvent(e)},TaskList.prototype.getFocusedEntry=function(){this.focusedTaskEntry&&!document.body.contains(this.focusedTaskEntry.node)&&this.clearFocus(this.focusedTaskEntry);var e=elementGetOwnerTaskEntry(getCaretControl());return e&&e!=this.focusedTaskEntry&&null!=this.focusedTaskEntry&&console.log("Focus is different from the active entry!"),this.focusedTaskEntry},TaskEntry.prototype.onEditClicked=function(){var e=new CustomEvent("editclicked",{bubbles:!0});e.entry=this,this.dispatchEvent(e)},TaskEntry.prototype.onChecked=function(){this.setCompleted(this.checkCtl.checked);var e=new CustomEvent("checked",{bubbles:!0});e.entry=this,this.dispatchEvent(e)},TaskEntry.prototype.onNodeClicked=function(e){if(e.target==e.currentTarget){var t=e.target.taskEntry;t.setCaret()}},TaskEntry.prototype.titleChanged=function(){var e=new CustomEvent("titlechanged",{bubbles:!0});e.entry=this,this.dispatchEvent(e)},TaskEntry.prototype.onTitleInput=function(){this.titleChanged()},TaskEntry.prototype.onTitlePaste=function(e){e.preventDefault();var t=e.clipboardData.getData("text/plain").replace("\r","").replace("\n",""),n=this.getSelection();if(!n)return void console.log("caret outside the paste-event control, wut");var o=this.getTitle();o=o.substring(0,n.startOffset)+t+o.substring(n.endOffset),this.setTitle(o),this.setCaret(n.startOffset+t.length),this.titleChanged()},TaskList.prototype.onEntryTitleFocusOut=function(e){var t=new CustomEvent("titlefocusout");t.entry=e.currentTarget.taskEntry,this.dispatchEvent(t)},TaskList.prototype.onEntryDragGripMouseDown=function(e){this.dragMgr.dragConfigure(elementGetOwnerTaskNode(e.target),e),this.dragMgr.startDrag(),e.stopPropagation(),e.preventDefault()},inherit(ItemDragMgr,TaskEntryDragMgr),TaskEntryDragMgr.prototype.getNodeChildren=function(e){return e.taskEntry.getAllChildren().map(function(e){return e.node})},TaskEntryDragMgr.prototype.dragStart=function(e){var t=new CustomEvent("dragstart");return t.entry=this.dragNode?this.dragNode.taskEntry:null,!!this.parent.dispatchEvent(t)&&ItemDragMgr.prototype.dragStart.call(this,e)},TaskEntryDragMgr.prototype.dragEnd=function(e){var t=new CustomEvent("dragend");if(t.entry=this.dragNode?this.dragNode.taskEntry:null,t.cancelDrag=e,this.parent.dispatchEvent(t),!!this.context){var n=e?this.context.oldLevel:this.dragNode.taskEntry.getLevel();if(n!=this.context.oldLevel){var o=_createForOfIteratorHelper(this.context.oldChildren.children),s;try{for(o.s();!(s=o.n()).done;){var a=s.value;a.taskEntry.setLevel(a.taskEntry.getLevel()-this.context.oldLevel+n)}}catch(e){o.e(e)}finally{o.f()}}return ItemDragMgr.prototype.dragEnd.call(this,e)}},TaskEntryDragMgr.prototype.dragMove=function(e){var t=new CustomEvent("dragmove");return t.entry=this.dragNode?this.dragNode.taskEntry:null,t.pos=e,this.parent.dispatchEvent(t),ItemDragMgr.prototype.dragMove.call(this,e)},TaskEntryDragMgr.prototype.getInsertPoints=function(e){return[e,e.nextElementSibling]},TaskEntryDragMgr.prototype.dragMoveBefore=function(e,t){e.parentNode.insertBefore(e,t);var n=t?t.taskEntry:null,o=n?n.getPrev():tasks.last(),s=n?n.getLevel():o?o.getLevel():0;e.taskEntry.setLevel(s)},TaskEntryDragMgr.prototype.saveContext=function(){var e=this.dragNode.taskEntry;this.context.oldPrev=e.getPrev(),this.context.oldLevel=e.getLevel()},TaskEntryDragMgr.prototype.restoreContext=function(){var e=this.dragNode.taskEntry;e.move(this.context.oldPrev,this.context.oldLevel)},TaskEntryDragMgr.prototype.dragCommit=function(){if(backend&&backend.move){var e=this.dragNode.taskEntry;this.context.oldPrev==e.getPrev()||this.parent.dispatchEvent("dragcommit",{entry:e})}},TaskList.prototype.entryFromViewportPoint=function(e){for(var t=this.first(),n=null;t&&(n=t.node.getBoundingClientRect(),!(e.y>=n.top&&e.y<n.bottom));)t=t.getNext();return t}},{"./utils.js":8}],8:[function(e,t,n){(function(t){'use strict';function _createForOfIteratorHelper(e,t){var a;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(a=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){a&&(e=a);var s=0,n=function F(){};return{s:n,n:function n(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var d=!0,r=!1,l;return{s:function s(){a=e[Symbol.iterator]()},n:function n(){var e=a.next();return d=e.done,e},e:function e(t){r=!0,l=t},f:function f(){try{d||null==a["return"]||a["return"]()}finally{if(r)throw l}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}function _typeof(e){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(e){return typeof e}:function _typeof(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function Unit(e){this.exports=e||{}}function importAll(n){for(var o in"string"==typeof n&&(n=e(n)),n)t[o]=n[o]}function optionsLoad(){s=Object.assign({},s,getLocalStorageItem("tasksIg_options"))}function optionsSave(){setLocalStorageItem("tasksIg_options",s),document.location.reload()}function optionsSetDefaults(e){for(var t in e)t in s||(s[t]=e[t]["default"])}function insertScript(e,t){console.debug("inserting script "+t);var n=document.createElement("script");return n.id=e,n.src=t,n.async=!0,n.defer=!0,n.handleReadyStateChange=function(){"complete"!=n.readyState||n.onload()},n.addEventListener("readystatechange",n.handleReadyStateChange),n.handleLoad=function(){n.finalizeLoad()},n.addEventListener("load",n.handleLoad),n.handleLoadError=function(){n.errorMessage||(n.errorMessage="Cannot load script "+t),n.finalizeLoad()},n.addEventListener("error",n.handleLoadError,!0),n.handleWindowError=function(e){e instanceof ErrorEvent&&e.filename.endsWith(n.src)&&(console.debug(t,": parsing error:",e),n.errorMessage=t+": "+e.message,n.dispatchEvent(new CustomEvent("error")),n.finalizeLoad())},window.addEventListener("error",n.handleWindowError,!0),n.finalizeLoad=function(){n.readyState||(n.readyState="complete"),n.removeEventListener("readystatechange",n.handleReadyStateChange),n.removeEventListener("load",n.handleLoad),n.removeEventListener("error",n.handleLoadError),window.removeEventListener("error",n.handleWindowError,!0)},document.body.append(n),n}function loadScript(e,t){return new Promise(function(n,o){var s=document.getElementById(e);return s&&"complete"==s.readyState?void(s.errorMessage?(console.log("script load already failed:",e),o(s.errorMessage)):(console.debug("script already loaded:",e),n())):void(!s&&(s=insertScript(e,t)),console.debug(s),s.addEventListener("load",function(){console.debug("loaded script",s),n()}),s.addEventListener("error",function(){console.debug("script load error",s,s.errorMessage),o(s.errorMessage)}))})}function inherit(e,t){t.prototype=Object.create(e.prototype),t.prototype.constructor=t}function getLocalStorageItem(e){var t=window.localStorage.getItem(e);return t?JSON.parse(t):null}function setLocalStorageItem(e,t){window.localStorage.setItem(e,JSON.stringify(t))}function Callback(){this.observers=[]}function JobQueue(){this.count=0,this.jobs=[],this.idlePromises=[],this.onChanged=new Callback,this.onError=new Callback}function resetSelection(){window.getSelection().removeAllRanges();var e=window.getSelection?window.getSelection():document.selection;e&&(e.removeAllRanges?e.removeAllRanges():e.empty&&e.empty())}function Editable(){}function nodeHasParent(e,t){for(;e&&e!=t;)e=e.parentNode;return e==t}function nodeRemoveAllChildren(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function downloadToFile(e,t,n){var o=new Blob([e],{type:t});if(window.navigator.msSaveOrOpenBlob)return void window.navigator.msSaveOrOpenBlob(o,n);var s=document.createElement("a"),a=URL.createObjectURL(o);s.href=a,s.download=n,document.body.appendChild(s),s.click(),setTimeout(function(){document.body.removeChild(s),window.URL.revokeObjectURL(a)},0)}function Action(){}function Actions(){}function HrHost(){}function Dropdown(){return Dropdown.init.apply(this,arguments)}function buttonNew(e,t,n){return e||(e=document.createElement("a")),e.classList.toggle("button",!0),t&&(e.id=t),n&&(e.textContent=n),e.title||(e.title=e.textContent),e}function html(){}function getInnerClientRect(e){var t=e.getBoundingClientRect(),n=t.width,o=t.height,s=getComputedStyle(e);return o-=parseFloat(s.borderTopWidth)+parseFloat(s.borderBottomWidth),n-=parseFloat(s.borderLeftWidth)+parseFloat(s.borderRightWidth),{width:n,height:o}}function createDragShield(){var e=document.createElement("div");return e.classList.toggle("dragging",!0),e.style.position="fixed",e.style.left="0px",e.style.right="0px",e.style.top="0px",e.style.bottom="0px",e.style.zIndex=99999,document.body.appendChild(e),e}function DragMgr(e){document.addEventListener("mousemove",this.onDocumentDragMouseMove.bind(this)),document.addEventListener("mouseup",this.onDocumentDragMouseUp.bind(this)),document.addEventListener("touchmove",this.onDocumentDragMouseMove.bind(this)),document.addEventListener("touchend",this.onDocumentDragMouseUp.bind(this)),document.addEventListener("touchcancel",this.onDocumentDragTouchCancel.bind(this)),e&&this.addElement(e),this.autoShield=!1,this.dragDelay=0,this.dragTolerance=0}function ItemDragMgr(){DragMgr.call(this)}function Splitter(e,t){this.box=e,this.box?this.autoDetectDirection():this.box=document.createElement("div"),this.id=t?t:this.box.id,this.sizeLoad(),this.dragMgr=new DragMgr(this.box),this.dragMgr.autoShield=!0,this.dragMgr.dragTolerance=0,this.dragMgr.dragStart=this.dragStart.bind(this),this.dragMgr.dragEnd=this.dragEnd.bind(this),this.dragMgr.dragMove=this.dragMove.bind(this),this.adjustShieldStyle()}function AddCustomEventTarget(e){e.prototype.setupEventTarget=AddCustomEventTarget.setupEventTarget,e.prototype.addEventListener=AddCustomEventTarget.addEventListener,e.prototype.removeEventListener=AddCustomEventTarget.removeEventListener,e.prototype.dispatchEvent=AddCustomEventTarget.dispatchEvent}function FormCancelError(){}function CustomPage(e){var t=this;this.page=e,this.setupEventTarget(),this.promise=new Promise(function(e,n){t.resolve=e,t.reject=n}),this.promise["catch"](function(){}).then(function(){t.promise=null,t.resolve=null,t.reject=null,t.close()})}Unit.prototype["export"]=function(e){if("undefined"==typeof e)throw Error("Cannot export undefined");if("function"==typeof e)this.exports[e.name]=e;else if("object"==_typeof(e))for(var t in e)this.exports[t]=e[t];else throw Error("Unit.export() cannot export "+(e+""))};var o=new Unit("undefined"!=typeof n&&n);o["export"](Unit),o["export"](importAll),o["export"](function importSelf(){return importAll(n),this});var s=s||{};o["export"]({options:s}),o["export"](optionsLoad),o["export"](optionsSave),o["export"](optionsSetDefaults),optionsLoad(),o["export"](loadScript),o["export"](function loadScripts(e){var t=[];return Object.keys(e).forEach(function(n){t.push(loadScript(n,e[n]))}),Promise.all(t)}),o["export"](function newGuid(){for(var e="",t=0,n=0|4294967295*Math.random();36>t++;){var o="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx"[t-1],s=15&n,a="x"==o?s:8|3&s;e+="-"==o||"4"==o?o:a.toString(16),n=0==t%8?0|4294967295*Math.random():n>>4}return e}),o["export"](inherit),o["export"](getLocalStorageItem),o["export"](setLocalStorageItem),Callback.prototype.subscribe=function(e){this.observers.push(e)},Callback.prototype.push=function(e){this.observers.push(e)},Callback.prototype.unsubscribe=function(e){this.observers=this.observers.filter(function(t){return t!==e})},Callback.prototype.notify=function(){var e=arguments,t=this;this.observers.forEach(function(n){return n.apply(t,e)})},o["export"](Callback),"undefined"==typeof Promise.allSettled&&(Promise.allSettled=function(e){var t=[],n=_createForOfIteratorHelper(e),o;try{for(n.s();!(o=n.n()).done;){var s=o.value;t.push(s.then(function(e){return{status:"fulfilled",value:e}})["catch"](function(e){return{status:"rejected",reason:e}}))}}catch(e){n.e(e)}finally{n.f()}return Promise.all(t)}),o["export"](JobQueue),JobQueue.prototype.push=function(e){var t=this;return this.count+=1,this.jobs.push(e),this.onChanged.notify(),e["catch"](function(e){return t.onError.notify(e)}).then(function(){t.count-=1;var n=t.jobs.indexOf(e);if(0<=n&&t.jobs.splice(n,1),0>=t.count)for(t.onChanged.notify();0<t.idlePromises.length&&0>=t.count;)t.idlePromises.splice(0,1)()}),e},JobQueue.prototype.waitIdle=function(){var e=this;return 0>=this.count?Promise.resolve():new Promise(function(t){e.idlePromises.push(t)})},JobQueue.prototype.addIdleJob=function(e){this.waitIdle().then(function(){return e()})},JobQueue.prototype.waitCurrentJobsCompleted=function(){return Promise.all(this.jobs)},JobQueue.prototype.waitCurrentJobsSettled=function(){return Promise.allSettled(this.jobs)},JobQueue.prototype.queueIndependentJob=function(e){var t=this.waitCurrentJobsSettled().then(function(){return e()});return this.push(t),t},o["export"](function urlWrite(e){var t="";if(e)for(var n in e)t=t+(0>=t.length?"#":"&")+n+"="+encodeURIComponent(e[n]);""==t&&(t="#"),document.location.href=t}),o["export"](function urlRead(){var e=document.location.href,t=e.indexOf("#");if(e=0<=t?e.slice(t+1):"",!e||0>=e.length)return null;var n=e.split("&");for(var o in e={},n){var s=n[o].split("=");if(!s||!s.length||2!=s.length){console.debug("Weird URI component:",n[o]);continue}e[s[0]]=decodeURIComponent(s[1])}return console.debug("url data:",e),e}),o["export"](resetSelection),o["export"](function getCaretControl(){var e=window.getSelection();if(!e.rangeCount)return null;var t=e.getRangeAt(0);return t.commonAncestorContainer});o["export"](Editable),Editable.getText=function(e){return e.textContent},Editable.setText=function(e,t){e.textContent=t},Editable.getTextNode=function(e){for(var t=0;t<e.childNodes.length;t++)if(e.childNodes[t].nodeType==Node.TEXT_NODE)return e.childNodes[t];return e},Editable.getLength=function(e){return Editable.getText(e).length},Editable.getSelection=function(e){var t=window.getSelection();if(!t.rangeCount)return null;var n=t.getRangeAt(0);return nodeHasParent(n.commonAncestorContainer,e)?n:null},Editable.getCaret=function(e){var t=Editable.getSelection(e);if(!t)return null;if(t.endContainer.nodeType==Node.TEXT_NODE)return t.endOffset;console.log("Editable.getCaret => in non-text: type="+t.endContainer.nodeType+", offset="+t.endOffset);for(var n=t.endContainer,o=t.endOffset;n!=e;)o=n.parentNode.childNodes.values().indexOf(n),n=n.parentNode;for(var s=t.endOffset;1<=s;)if(n.childNodes[s-1].nodeType==Node.TEXT_NODE)return console.log("Editable.getCaret: caret is to the right"),n.childNodes[s-1].textContent.length;return console.log("Editable.getCaret: caret is to the left/empty text"),0},Editable.setCaret=function(e,t,n){var o=document.createRange(),s=Editable.getTextNode(e),a=s.textContent;t&&t>a.length&&(t=a.length),n&&n>a.length&&(n=a.length),o.setStart(s,t),n?o.setEnd(s,n):o.collapse(!0);var i=window.getSelection();i.removeAllRanges(),i.addRange(o),Editable.setFocus(s)},Editable.setFocus=function(e){for(;e&&"undefined"==typeof e.focus;)e=e.parentNode;e&&e!=document.activeElement&&e.focus()},o["export"](nodeHasParent),o["export"](nodeRemoveAllChildren),o["export"](function nodeRemoveChildrenByTagName(e,t){for(var n=e.getElementsByTagName(t);0<n.length;)e.removeChild(n[n.length-1])}),o["export"](downloadToFile),o["export"](function downloadAsJson(e,t){return downloadToFile(JSON.stringify(e),"application/json",t+".json")}),o["export"](function copyToClipboard(e){var t=document.createElement("input");document.body.appendChild(t),t.value=e,t.select(),document.execCommand("copy"),document.body.removeChild(t)}),o["export"](Action),o["export"](Actions),Actions.getScopeData=function(e){return e||(e=document),"undefined"==typeof e.actions&&(e.actions={},e.addEventListener("click",Actions.onClick)),e.actions},Actions.get=function(e,t){var n=Actions.getScopeData(e),o=n[t];return o||(o=new Action,n[t]=o),o},Actions.bind=function(e,t,n){var o=Actions.get(e,t);return o.handler=n,o},Actions.find=function(e,t,n){var o=(e||document).actions;return o?o[t]||n||null:null},Actions.getAssignedActionName=function(e){return"undefined"==typeof e.action?e.getAttribute("action"):e.action},Actions.getActionClients=function(e,t){return e.querySelectorAll("[action="+t+"]")},Actions.containsClass=function(e,t,n){var o=_createForOfIteratorHelper(Actions.getActionClients(e,t)),s;try{for(o.s();!(s=o.n()).done;){var a=s.value;if(a.classList.contains(n))return!0}}catch(e){o.e(e)}finally{o.f()}return!1},Actions.toggleClass=function(e,t,n,o){var s=_createForOfIteratorHelper(Actions.getActionClients(e,t)),a;try{for(s.s();!(a=s.n()).done;){var i=a.value;i.classList.toggle(n,o)}}catch(e){s.e(e)}finally{s.f()}},Actions.setDisabled=function(e,t,n){Actions.toggleClass(e,t,"hidden",n)},Actions.setEnabled=function(e,t,n){Actions.setDisabled(e,t,!n)},Actions.getChecked=function(e,t){return Actions.containsClass(e,t,"checked")},Actions.setChecked=function(e,t,n){var o=Actions.find(e,t,null);o&&Actions.toggleClass(e,t,"checked",n)},Actions.onClick=function(e){if(0==e.button){var t=Actions.getAssignedActionName(e.target);if(t){var n=Actions.find(e.currentTarget,t);n&&(n.autoCheck&&Actions.setChecked(e.currentTarget,t,!e.target.classList.contains("checked")),n.handler.apply(this,arguments))}}},o["export"](HrHost),HrHost.collapseHrs=function(e){var t=!0,n=_createForOfIteratorHelper(e.children),o;try{for(n.s();!(o=n.n()).done;){var s=o.value,a="hr"==(s.tagName||"").toLowerCase();s.classList.toggle("collapsed",a&&t),a?t=s:"none"!=getComputedStyle(s,null).display&&(t=null)}}catch(e){n.e(e)}finally{n.f()}t&&"object"==_typeof(t)&&t.classList.toggle("collapsed",!0)},HrHost.AutoCollapseHrs=function(e){var t=new MutationObserver(HrHost.mutationCallback.bind(e));return t.observe(e,{attributes:!0,subtree:!0}),HrHost.collapseHrs(e),t},HrHost.mutationCallback=function(e){var t=!1,n=_createForOfIteratorHelper(e),o;try{for(n.s();!(o=n.n()).done;){var s=o.value;"hr"==(s.target.tagName||"").toLowerCase()||"attributes"!==s.type||"class"!==s.attributeName||(t=!0)}}catch(e){n.e(e)}finally{n.f()}t&&HrHost.collapseHrs(this)},Dropdown.init=function(e){"string"==typeof e?e=document.getElementById(e):!e&&(e=document.createElement("div")),e.classList.toggle("dropdown",!0);var t=document.createElement("div");for(t.className="dropdown-content";e.firstChild;)t.appendChild(e.firstChild);var n=document.createElement("span");return n.className="dropbtn",n.addEventListener("click",Dropdown.click),e.appendChild(n),e.button=n,e.appendChild(t),e.menu=t,e.clear=Dropdown.clear,e.add=Dropdown.add,e.addSeparator=Dropdown.addSeparator,e.hrCollapser=HrHost.AutoCollapseHrs(t),e},o["export"](Dropdown),Dropdown.clear=function(){nodeRemoveAllChildren(this.menu)},Dropdown.add=function(e,t){var n=document.createElement("a");return e&&(n.textContent=e),t&&(n.className=t),this.menu.appendChild(n),n},Dropdown.addSeparator=function(e){var t=document.createElement("hr");return e&&(t.id=e),this.menu.appendChild(t),t},Dropdown.getButton=function(e){return e.getElementsByClassName("dropbtn")[0]},Dropdown.getContent=function(e){return e.getElementsByClassName("dropdown-content")[0]},Dropdown.click=function(e){e.target.classList.toggle("dropopen"),Dropdown.getContent(e.target.parentNode).classList.toggle("show")},window.addEventListener("click",function(e){for(var t=document.getElementsByClassName("dropdown-content"),n=0,o;n<t.length;n++)o=Dropdown.getButton(t[n].parentNode),e.target!=o&&t[n].classList.contains("show")&&(o.classList.remove("dropopen"),t[n].classList.remove("show"))}),o["export"](function Toolbar(e){return e||(e=document.createElement("div")),e.hrCollapser=HrHost.AutoCollapseHrs(e),e}),o["export"](buttonNew),window.addEventListener("load",function(){var e=_createForOfIteratorHelper(document.getElementsByClassName("button")),t;try{for(e.s();!(t=e.n()).done;){var n=t.value;buttonNew(n)}}catch(t){e.e(t)}finally{e.f()}}),o["export"](function linkNew(e,t,n){var o=document.createElement("a");return o.href="#",e&&(o.id=e),n&&(o.textContent=n),t&&o.addEventListener("click",t),o}),o["export"](html),html.factory=function(e){return function(t,n){var o=document.createElement(e);if("string"==typeof t?o.textContent=t:t&&o.appendChild(t),n)for(var s in n)o[s]=n[s];return o}};for(var a=0,i=["p","div","li","br"],d;a<i.length;a++)d=i[a],html[d]=html.factory(d);html.text=function(e){return document.createTextNode(e)},o["export"](getInnerClientRect),o["export"](function getContentRect(e){var t=e.clientWidth,n=e.clientHeight,o=getComputedStyle(e);return n-=parseFloat(o.paddingTop)+parseFloat(o.paddingBottom),t-=parseFloat(o.paddingLeft)+parseFloat(o.paddingRight),{width:t,height:n}}),o["export"](function relativeBoundingRect(e,t){var n=t?t.offsetParent:null,o={top:0,left:0,bottom:0,right:0};if(e){var s=e.getBoundingClientRect();o.top=s.top,o.left=s.left,o.bottom=s.bottom,o.right=s.right}for(;e.offsetParent&&e.offsetParent!=n;){e=e.offsetParent;var a=e.getBoundingClientRect();o.left+=a.left,o.top+=a.top,o.right+=a.left,o.bottom+=a.top}if(t){var i=t.getBoundingClientRect();o.left-=i.left,o.top-=i.top,o.right-=i.left,o.bottom-=i.top}return o}),o["export"](createDragShield),o["export"](DragMgr),DragMgr.prototype.addElement=function(e){e.addEventListener("dragstart",function(){return!1}),e.addEventListener("mousedown",this.onDragMouseDown.bind(this)),e.addEventListener("mousemove",this.onDragMouseMove.bind(this)),e.addEventListener("mouseup",this.onDragMouseUp.bind(this)),e.addEventListener("touchstart",this.onDragMouseDown.bind(this)),e.addEventListener("touchmove",this.onDragMouseMove.bind(this)),e.addEventListener("touchend",this.onDragMouseUp.bind(this)),e.addEventListener("touchcancel",this.onDragTouchCancel.bind(this))},DragMgr.prototype.dragConfigure=function(e,t){this.dragStartTimerAbort(),this.dragNode=e,this.dragStartPos={x:t.pageX,y:t.pageY};for(var n=t.touches?{x:t.touches[0].offsetX,y:t.touches[0].offsetY}:{x:t.offsetX,y:t.offsetY},o=t.target;o&&o!=this.dragNode;)n.x+=o.offsetLeft,n.y+=o.offsetTop,o=o.offsetParent;this.dragOffsetPos=n},DragMgr.prototype.dragStartTimerAbort=function(){this.dragStartTimer&&clearTimeout(this.dragStartTimer),this.dragStartTimer=null},DragMgr.prototype.onDragMouseDown=function(e){return this.dragConfigure(e.currentTarget,e),0<this.dragDelay?void(this.dragStartTimer=setTimeout(this.startDrag.bind(this),this.dragDelay)):void(0<this.dragTolerance||(this.startDrag(),e.stopPropagation(),e.preventDefault()))},DragMgr.prototype.onDragMouseUp=function(){this.dragStartTimerAbort(),this.endDrag(!1)},DragMgr.prototype.onDragTouchCancel=function(){this.dragStartTimerAbort(),this.endDrag(!0)},DragMgr.prototype.onDragMouseMove=function(e){0<this.dragDelay&&!this.dragging&&this.dragStartTimerAbort(),(this.dragging||0<this.dragTolerance&&this.dragNode)&&e.preventDefault()},DragMgr.prototype.onDocumentDragMouseMove=function(e){!this.dragging&&0<this.dragTolerance&&this.dragNode&&Math.abs(e.pageX-this.dragStartPos.x+e.pageY-this.dragStartPos.y)>this.dragTolerance&&this.startDrag(),this.dragging&&(e.touches?this.dragMove({x:e.touches[0].clientX,y:e.touches[0].clientY}):this.dragMove({x:e.clientX,y:e.clientY}),e.preventDefault())},DragMgr.prototype.onDocumentDragMouseUp=function(e){(this.dragging||this.dragNode)&&this.onDragMouseUp(e)},DragMgr.prototype.onDocumentDragTouchCancel=function(e){(this.dragging||this.dragNode)&&this.onDragTouchCancel(e)},DragMgr.prototype.startDrag=function(){if(this.dragStartTimerAbort(),this.dragging=!0,!this.dragStart(this.dragNode))return void(this.dragging=!1);this.autoShield&&(this.shield=createDragShield(),this.autoShieldCursorStyle&&(this.shield.style.cursor=this.autoShieldCursorStyle));var e=this.dragNode.getBoundingClientRect();this.dragMove({x:e.left+this.dragOffsetPos.x,y:e.top+this.dragOffsetPos.y})},DragMgr.prototype.endDrag=function(e){if(!this.dragging)return void(this.dragNode=null);this.dragging=!1,this.shield&&(document.body.removeChild(this.shield),delete this.shield);this.dragNode&&(this.dragEnd(e),this.dragNode=null)},DragMgr.prototype.dragStart=function(){return!0},DragMgr.prototype.dragEnd=function(){},DragMgr.prototype.dragMove=function(){},inherit(DragMgr,ItemDragMgr),o["export"](ItemDragMgr),ItemDragMgr.prototype.dragStart=function(e){document.activeElement.blur(),resetSelection(),this.dragNode||(this.dragNode=e),this.context={},this.saveContext(),this.dragNode.classList.toggle("dragging",!0),this.context.oldChildren=document.createElement("div"),this.context.oldChildren.style.display="none";var t=_createForOfIteratorHelper(this.getNodeChildren(this.dragNode)),n;try{for(t.s();!(n=t.n()).done;){var o=n.value;this.context.oldChildren.insertBefore(o,null)}}catch(e){t.e(e)}finally{t.f()}return!0},ItemDragMgr.prototype.dragEnd=function(e){if(this.context){var t=this.dragNode;t.classList.remove("dragging"),e&&this.restoreContext();for(var n=t.nextElementSibling,o;void 0<this.context.oldChildren.children.length;)o=this.context.oldChildren.children[void 0],t.parentNode.insertBefore(o,n);e||this.dragCommit(),delete this.context}},ItemDragMgr.prototype.dragMove=function(e){if(this.context){var t=this.dragNode,n=this.nodeFromViewportPoint(e);if(n&&n!=t){var o=this.getInsertPoints(n),s=ItemDragMgr.dragMoveObj(t,e,o);"undefined"!=typeof s&&s!=t&&s!=t.nextSibling&&this.dragMoveBefore(t,s)}}},ItemDragMgr.prototype.dragMoveBefore=function(e,t){e.parentNode.insertBefore(e,t)},ItemDragMgr.prototype.getNodeChildren=function(){return[]},ItemDragMgr.prototype.getInsertPoints=function(){return[]},ItemDragMgr.prototype.saveContext=function(){this.context.oldPrev=this.dragNode.previousElementSibling},ItemDragMgr.prototype.restoreContext=function(){var e=this.context.oldPrev;this.dragNode.previousElementSibling!=e&&(e?e.parentNode.insertBefore(this.dragNode,e.nextElementSibling):this.dragNode.parentNode.insertBefore(this.dragNode,this.dragNode.parentNode.firstElementChild))},ItemDragMgr.prototype.dragCommit=function(){},ItemDragMgr.prototype.nodeFromViewportPoint=function(e){if(!this.dragNode)return null;for(var t=this.dragNode.parentNode.firstElementChild,n=null;t&&(n=t.getBoundingClientRect(),!(e.y>=n.top&&e.y<n.bottom));)t=t.nextElementSibling;return t},ItemDragMgr.dragMove=function(e,t,n,o){var s=e.y>=n?n:n-e.height,a=e.y>=o?o+e.height:o,i=t.y>(s+a)/2?2:1;return 2==i&&e.y==o||1==i&&e.y==n?0:i},ItemDragMgr.getInsertionPointRect=function(e,t,n,o){if(t){var s=t.getBoundingClientRect();if(0!=s.x||0!=s.y||0!=s.width||0!=s.height)return s;t=t.previousElementSibling}else{if(!e)return new DOMRect(0,0,0,0);t=e.lastElementChild}for(;t;){var a=!n||t!=n?t.getBoundingClientRect():o;if(0!=a.x||0!=a.y||0!=a.width||0!=a.height)return new DOMRect(a.right,a.bottom,0,0)}if(e){var i=e.getBoundingClientRect();return new DOMRect(i.left,i.top,0,0)}return new DOMRect(0,0,0,0)},ItemDragMgr.dragMoveObj=function(e,t,n){var o=e.getBoundingClientRect();if(n&&n.length&&!(0>=n.length)){for(var s=null,a=0,d;a<n.length;a++){if(d=this.getInsertionPointRect(e.parentElement,n[a],0<a?n[a-1]:null,s),t.y<d.y){if(!s)return n[a];var r=this.dragMove(o,t,s.y,d.y);return 2==r?n[a]:1==r?n[a-1]:void 0}s=d}return n[n.length-1]}},o["export"](Splitter),Splitter.ID_BASE="splitter_",Splitter.prototype.autoDetectDirection=function(){var e=window.getComputedStyle(this.box.parentElement);"row"==e.flexDirection?this.setDirection("V"):"column"==e.flexDirection?this.setDirection("H"):this.setDirection(null),this.adjustShieldStyle();var t=this.box.previousElementSibling,n=t?window.getComputedStyle(t):null,o=this.box.nextElementSibling,s=o?window.getComputedStyle(o):null;this.growElement=n&&s?s.flexGrow?t:o:null},Splitter.prototype.setDirection=function(e){this.direction=e,this.box.classList.toggle("splitter",!0),this.box.classList.toggle("splitterV","V"==this.direction),this.box.classList.toggle("splitterH","H"==this.direction)},Splitter.prototype.adjustShieldStyle=function(){this.dragMgr&&("V"==this.direction?this.dragMgr.autoShieldCursorStyle="ew-resize":"H"==this.direction?this.dragMgr.autoShieldCursorStyle="ns-resize":this.dragMgr.autoShieldCursorStyle="move")},Splitter.prototype.sizeSave=function(){if(this.id&&this.growElement){var e=getInnerClientRect(this.growElement);"H"==this.direction?setLocalStorageItem(Splitter.ID_BASE+this.id+".height",e.height):setLocalStorageItem(Splitter.ID_BASE+this.id+".width",e.width)}},Splitter.prototype.sizeLoad=function(){if(this.id&&this.growElement)if("H"==this.direction){var e=+getLocalStorageItem(Splitter.ID_BASE+this.id+".height");e&&(this.growElement.style.height=e+"px")}else{var t=+getLocalStorageItem(Splitter.ID_BASE+this.id+".width");t&&(this.growElement.style.width=t+"px")}},Splitter.prototype.dragStart=function(){if(this.growElement)return this.dragBoxStart=this.box.getBoundingClientRect(),this.dragElementStart=getInnerClientRect(this.growElement),this.dragElementBackup={width:this.growElement.style.width,height:this.growElement.style.height},!0},Splitter.prototype.dragMove=function(e){if(this.growElement){var t=e.x-this.dragBoxStart.width/2-this.dragBoxStart.x,n=e.y-this.dragBoxStart.height/2-this.dragBoxStart.y,o=this.dragElementStart.width+t,s=this.dragElementStart.height+n;"H"==this.direction?this.growElement.style.height=s+"px":this.growElement.style.width=o+"px"}},Splitter.prototype.dragEnd=function(e){delete this.dragBoxStart,delete this.dragElementStart,e&&"undefined"!=typeof this.dragElementBackup?(this.growElement.style.width=this.dragElementBackup.width,this.growElement.style.height=this.dragElementBackup.height,delete this.dragElementBackup):this.sizeSave()},o["export"](AddCustomEventTarget),AddCustomEventTarget.setupEventTarget=function(e){this.eventTarget=e,this.eventTarget||(this.eventTarget=document.createElement("div"))},AddCustomEventTarget.addEventListener=function(){this.eventTarget.addEventListener.apply(this.eventTarget,arguments)},AddCustomEventTarget.removeEventListener=function(){this.eventTarget.removeEventListener.apply(this.eventTarget,arguments)},AddCustomEventTarget.dispatchEvent=function(e,t){if("string"==typeof e&&(e=new CustomEvent(e)),t)for(var n in t)e[n]=t[n];return this.eventTarget.dispatchEvent(e)},o["export"](FormCancelError),o["export"](CustomPage),AddCustomEventTarget(CustomPage),CustomPage.prototype.waitResult=function(){return this.promise},CustomPage.prototype.okClick=function(e){e||(e=this.collectResults()),this.dispatchEvent("ok",{results:e})},CustomPage.prototype.collectResults=function(){return null},CustomPage.prototype.cancelClick=function(){this.dispatchEvent("cancel"),this.reject(new FormCancelError)},CustomPage.prototype.close=function(){},s&&!s.debug?console.debug=function(){}:!console.debug&&(console.debug=function(){console.log.apply(this,arguments)})}).call(this,"undefined"==typeof global?"undefined"==typeof self?"undefined"==typeof window?{}:window:self:global)},{}]},{},[6])(6)});